<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ø§Ù† Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ â€” Ù†Ø³Ø®Ù‡Ù” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent-500:#10b981;
      --accent-600:#059669;
      --bg-1: #0f172a;
      --card-bg: rgba(255,255,255,0.96);
      --glass-bg: rgba(255,255,255,0.06);
    }
    html,body{height:100%}
    body{
      font-family: "Vazirmatn", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(145deg,var(--bg-1) 0%, #1e293b 50%, var(--bg-1) 100%);
      color: #0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:20px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    /* Container */
    .container{
      width:100%;
      max-width:980px;
      margin:8px;
    }

    /* Glass card override for readability */
    .glass-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.93));
      border-radius:18px;
      box-shadow: 0 18px 40px rgba(2,6,23,0.6);
      border:1px solid rgba(16,185,129,0.06);
    }

    /* monospace prompt box */
    .prompt-mono{
      font-family: "Vazirmatn", ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace;
    }

    /* subtle scrollbar for prompt area */
    .prompt-scroll::-webkit-scrollbar{width:7px}
    .prompt-scroll::-webkit-scrollbar-track{background:transparent}
    .prompt-scroll::-webkit-scrollbar-thumb{background:rgba(16,185,129,0.3);border-radius:6px}

    /* small transitions */
    .soft-trans{transition: all .18s cubic-bezier(.2,.9,.2,1)}
  </style>
</head>
<body>

  <div class="container">

    <!-- Header -->
    <header class="text-center mb-6">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-br from-emerald-400 to-green-600 mb-3 shadow-lg">
        <span class="text-3xl">âš¡</span>
      </div>
      <h1 class="text-2xl font-extrabold text-white">Ø§Ù„Ø§Ù† Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ</h1>
      <p class="text-gray-300 text-sm mt-1">Û´ Ø³Ø¤Ø§Ù„ Ú©ÙˆØªØ§Ù‡ â€” Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” ÙÙˆØ±ÛŒØŒ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ùˆ Ù‚Ø§Ø¨Ù„ ØªÚ©Ø±Ø§Ø±</p>
      <p class="text-gray-400 text-xs mt-1">Ù…Ù†Ø§Ø³Ø¨Ù Ú©Ø³ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ø²Ù†Ø¯Ú¯ÛŒâ€ŒØ§Ø´ Ú©Ù†Ø¯</p>
    </header>

    <!-- Main card -->
    <main class="glass-card overflow-hidden">

      <!-- Progress -->
      <div class="px-6 pt-6">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-3 w-full">
            <div class="flex items-center gap-2 w-full">
              <div class="flex items-center gap-2 w-full">
                <!-- Step dots + bars -->
                <div class="flex items-center justify-between w-full">
                  <div class="flex items-center gap-3 w-full">
                    <div class="step-dot w-3 h-3 rounded-full bg-gray-600" data-step="1" aria-hidden="true"></div>
                    <div class="progress-line h-1 bg-gray-700 rounded flex-1 relative">
                      <div id="progressBar" class="absolute left-0 top-0 h-full rounded bg-gradient-to-r from-emerald-500 to-emerald-600" style="width:25%"></div>
                    </div>
                    <div class="step-dot w-3 h-3 rounded-full bg-gray-600" data-step="2" aria-hidden="true"></div>
                    <div class="progress-line h-1 bg-gray-700 rounded flex-1 relative">
                      <div class="h-full rounded bg-gradient-to-r from-emerald-500 to-emerald-600" style="width:0%"></div>
                    </div>
                    <div class="step-dot w-3 h-3 rounded-full bg-gray-600" data-step="3" aria-hidden="true"></div>
                    <div class="progress-line h-1 bg-gray-700 rounded flex-1 relative">
                      <div class="h-full rounded bg-gradient-to-r from-emerald-500 to-emerald-600" style="width:0%"></div>
                    </div>
                    <div class="step-dot w-3 h-3 rounded-full bg-gray-600" data-step="4" aria-hidden="true"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p class="text-center text-gray-400 text-xs mt-3">Ù…Ø±Ø­Ù„Ù‡ <span id="currentStepNum" class="text-emerald-400 font-bold">Û±</span> Ø§Ø² Û´</p>
      </div>

      <!-- Steps / Form -->
      <section id="stepsWrap" class="px-6 py-6">
        <!-- STEP 1 -->
        <div class="step-panel" data-step="1">
          <div class="p-5">
            <div class="text-center mb-4">
              <div class="text-4xl">ğŸ¯</div>
              <h2 class="text-lg font-bold text-gray-800 mt-2">Ø§Ù„Ø§Ù† Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ú†ÛŒÚ©Ø§Ø± Ú©Ù†ÛŒØŸ</h2>
              <p class="text-gray-500 text-sm mt-1">Ù‡Ù…ÛŒÙ† Ø³Ø§Ø¹ØªÙ Ø¢ÛŒÙ†Ø¯Ù‡ â€” Ú©ÙˆÚ†Ú© Ùˆ Ù…Ø´Ø®Øµ</p>
            </div>

            <div class="space-y-4">
              <input id="taskInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø®ÙˆØ§Ù†Ø¯Ù† ÛŒÚ© ÙØµÙ„..." class="w-full input-field rounded-xl px-4 py-3 text-sm soft-trans" />

              <div class="grid grid-cols-4 gap-3">
                <button type="button" class="task-btn option-card rounded-lg py-3 soft-trans flex flex-col items-center justify-center" data-emoji="ğŸ“š" data-value="Ø¯Ø±Ø³">
                  <div class="text-2xl">ğŸ“š</div>
                  <div class="text-xs text-gray-600 mt-1">Ø¯Ø±Ø³</div>
                </button>

                <button type="button" class="task-btn option-card rounded-lg py-3 soft-trans flex flex-col items-center justify-center" data-emoji="ğŸ’¼" data-value="Ú©Ø§Ø±">
                  <div class="text-2xl">ğŸ’¼</div>
                  <div class="text-xs text-gray-600 mt-1">Ú©Ø§Ø±</div>
                </button>

                <button type="button" class="task-btn option-card rounded-lg py-3 soft-trans flex flex-col items-center justify-center" data-emoji="ğŸƒ" data-value="ÙˆØ±Ø²Ø´">
                  <div class="text-2xl">ğŸƒ</div>
                  <div class="text-xs text-gray-600 mt-1">ÙˆØ±Ø²Ø´</div>
                </button>

                <button type="button" class="task-btn option-card rounded-lg py-3 soft-trans flex flex-col items-center justify-center" data-emoji="ğŸ§¹" data-value="Ø®ÙˆÙ†Ù‡">
                  <div class="text-2xl">ğŸ§¹</div>
                  <div class="text-xs text-gray-600 mt-1">Ø®ÙˆÙ†Ù‡</div>
                </button>
              </div>

              <p id="taskHint" class="text-gray-400 text-xs">Ù†Ú©ØªÙ‡: Ù‡Ø¯Ùâ€Œâ€Œâ€ŒÙ‡Ø§ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© Ø¨Ø§Ø´Ù† â€” Ø¨Ù‡ØªØ± Ø§Ø² Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙˆØ¹ Ú©Ø±Ø¯Ù†Ù‡.</p>
            </div>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="step-panel hidden" data-step="2">
          <div class="p-5">
            <div class="text-center mb-4">
              <div class="text-4xl">âš¡</div>
              <h2 class="text-lg font-bold text-gray-800 mt-2">Ø§Ù„Ø§Ù† Ú†Ù‚Ø¯Ø± Ø§Ù†Ø±Ú˜ÛŒ Ø¯Ø§Ø±ÛŒØŸ</h2>
            </div>

            <div class="mb-4">
              <div class="relative mb-3">
                <div class="energy-track h-2 rounded w-full"></div>
                <input id="energyRange" type="range" min="1" max="10" value="5" class="absolute inset-x-0 top-0 w-full h-2 appearance-none bg-transparent" />
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-xs">ğŸ˜´</span>
                <span id="energyValue" class="text-2xl font-bold text-emerald-600">Ûµ</span>
                <span class="text-gray-400 text-xs">ğŸ”¥</span>
              </div>
            </div>

            <div>
              <label class="block text-gray-700 font-medium text-sm mb-2">Ø­Ø§Ù„Ù Ø±ÙˆØ­ÛŒØŸ</label>
              <div class="grid grid-cols-4 gap-3">
                <button type="button" class="mood-btn emoji-btn rounded-lg py-3 soft-trans bg-gray-100 flex flex-col items-center justify-center" data-mood="Ø¹Ø§Ù„ÛŒ">ğŸ˜Š<span class="text-xs text-gray-600 mt-1">Ø¹Ø§Ù„ÛŒ</span></button>
                <button type="button" class="mood-btn emoji-btn rounded-lg py-3 soft-trans bg-gray-100 flex flex-col items-center justify-center" data-mood="Ù…Ø¹Ù…ÙˆÙ„ÛŒ">ğŸ˜<span class="text-xs text-gray-600 mt-1">Ù…Ø¹Ù…ÙˆÙ„ÛŒ</span></button>
                <button type="button" class="mood-btn emoji-btn rounded-lg py-3 soft-trans bg-gray-100 flex flex-col items-center justify-center selected" data-mood="Ø®Ø³ØªÙ‡">ğŸ˜”<span class="text-xs text-gray-600 mt-1">Ø®Ø³ØªÙ‡</span></button>
                <button type="button" class="mood-btn emoji-btn rounded-lg py-3 soft-trans bg-gray-100 flex flex-col items-center justify-center" data-mood="Ø§Ø³ØªØ±Ø³ÛŒ">ğŸ˜°<span class="text-xs text-gray-600 mt-1">Ø§Ø³ØªØ±Ø³</span></button>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 3 -->
        <div class="step-panel hidden" data-step="3">
          <div class="p-5">
            <div class="text-center mb-4">
              <div class="text-4xl">â°</div>
              <h2 class="text-lg font-bold text-gray-800 mt-2">Ø§Ù„Ø§Ù† Ú†Ù‚Ø¯Ø± ÙˆÙ‚Øª Ø¯Ø§Ø±ÛŒØŸ</h2>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <label class="cursor-pointer">
                <input type="radio" name="time" value="Û±Ûµ-Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡" class="hidden peer">
                <div class="option-card rounded-xl p-3 text-center soft-trans peer-checked:bg-emerald-500 peer-checked:text-white">âš¡<div class="text-xs mt-1 text-gray-500 peer-checked:text-white">Û±Ûµ-Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡</div></div>
              </label>

              <label class="cursor-pointer">
                <input type="radio" name="time" value="Û± Ø³Ø§Ø¹Øª" class="hidden peer" checked>
                <div class="option-card rounded-xl p-3 text-center soft-trans bg-emerald-500 text-white">ğŸ•<div class="text-xs mt-1">Û± Ø³Ø§Ø¹Øª</div></div>
              </label>

              <label class="cursor-pointer">
                <input type="radio" name="time" value="Û²+ Ø³Ø§Ø¹Øª" class="hidden peer">
                <div class="option-card rounded-xl p-3 text-center soft-trans peer-checked:bg-emerald-500 peer-checked:text-white">ğŸ“…<div class="text-xs mt-1 text-gray-500 peer-checked:text-white">Û²+ Ø³Ø§Ø¹Øª</div></div>
              </label>
            </div>
          </div>
        </div>

        <!-- STEP 4 -->
        <div class="step-panel hidden" data-step="4">
          <div class="p-5">
            <div class="text-center mb-4">
              <div class="text-4xl">ğŸš§</div>
              <h2 class="text-lg font-bold text-gray-800 mt-2">Ú†ÛŒ Ù…Ù…Ú©Ù†Ù‡ Ø­ÙˆØ§Ø³ØªÙˆ Ù¾Ø±Øª Ú©Ù†Ù‡ØŸ</h2>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
              <label class="cursor-pointer">
                <input type="radio" name="barrier" value="Ú¯ÙˆØ´ÛŒ" class="hidden peer" checked>
                <div class="option-card rounded-xl p-3 text-center soft-trans bg-emerald-500 text-white">ğŸ“±<div class="text-sm mt-1">Ú¯ÙˆØ´ÛŒ</div></div>
              </label>

              <label class="cursor-pointer">
                <input type="radio" name="barrier" value="Ø®Ø³ØªÚ¯ÛŒ" class="hidden peer">
                <div class="option-card rounded-xl p-3 text-center soft-trans peer-checked:bg-emerald-500 peer-checked:text-white">ğŸ˜´<div class="text-sm mt-1 text-gray-700 peer-checked:text-white">Ø®Ø³ØªÚ¯ÛŒ</div></div>
              </label>

              <label class="cursor-pointer">
                <input type="radio" name="barrier" value="Ø³Ø± Ùˆ ØµØ¯Ø§" class="hidden peer">
                <div class="option-card rounded-xl p-3 text-center soft-trans peer-checked:bg-emerald-500 peer-checked:text-white">ğŸ”Š<div class="text-sm mt-1 text-gray-700 peer-checked:text-white">Ø³Ø± Ùˆ ØµØ¯Ø§</div></div>
              </label>

              <label class="cursor-pointer">
                <input type="radio" name="barrier" value="Ø¨ÛŒâ€ŒØ­ÙˆØµÙ„Ú¯ÛŒ" class="hidden peer">
                <div class="option-card rounded-xl p-3 text-center soft-trans peer-checked:bg-emerald-500 peer-checked:text-white">ğŸ˜‘<div class="text-sm mt-1 text-gray-700 peer-checked:text-white">Ø¨ÛŒâ€ŒØ­ÙˆØµÙ„Ú¯ÛŒ</div></div>
              </label>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 text-center">
              <p class="text-emerald-800 text-sm">âœ¨Ù‡Ù…Ù‡ Ú†ÛŒ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª â€” Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ… Ø¨Ø±ÛŒÙ…</p>
            </div>
          </div>
        </div>

      </section>

      <!-- Navigation -->
      <div class="px-6 pb-6">
        <div class="flex gap-3">
          <button id="prevBtn" class="hidden flex-1 py-3 px-4 bg-white/10 hover:bg-white/20 text-white font-medium rounded-xl transition-all text-sm soft-trans">â† Ù‚Ø¨Ù„ÛŒ</button>
          <button id="nextBtn" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 py-3 px-4 text-white font-bold rounded-xl text-sm soft-trans">Ø¨Ø¹Ø¯ÛŒ â†’</button>
          <button id="generateBtn" class="hidden flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 py-3 px-4 text-white font-bold rounded-xl text-sm soft-trans">âš¡ Ø¨Ø³Ø§Ø²!</button>
        </div>
      </div>

      <!-- Result -->
      <div id="resultSection" class="px-6 pb-6 hidden">
        <div class="glass-card p-4 prompt-mono">
          <div class="text-center mb-3">
            <div class="text-3xl">ğŸ‰</div>
            <h3 class="text-xl font-bold text-gray-800 mt-2">Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” ÙÙˆØ±ÛŒ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª</h3>
            <p class="text-gray-500 text-sm mt-1">Ú©Ù¾ÛŒ Ú©Ù† ÛŒØ§ Ù„ÛŒÙ†Ú© Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† â€” Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ÙÙˆØ±ÛŒ</p>
          </div>

          <div class="mb-3">
            <div class="bg-[#071329] rounded-xl p-3 prompt-scroll max-h-56 overflow-auto border border-emerald-500/20">
              <pre id="promptOutput" class="text-emerald-300 text-sm leading-relaxed whitespace-pre-wrap"></pre>
            </div>
          </div>

          <div class="flex gap-3">
            <button id="copyBtn" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white py-3 rounded-xl font-bold">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            <button id="shareBtn" class="flex-1 bg-white text-emerald-600 py-3 rounded-xl font-bold">ğŸ”— Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
            <button id="resetBtn" class="py-3 px-4 bg-gray-100 text-gray-700 rounded-xl">ğŸ”„ Ø±ÛŒØ³Øª</button>
          </div>
        </div>
      </div>

      <!-- Save indicator -->
      <div id="saveIndicator" class="fixed bottom-5 left-5 bg-gray-900/90 text-white px-3 py-1.5 rounded-full text-xs flex items-center gap-2 opacity-0 transition-all duration-300">
        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
        Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯
      </div>

    </main>
  </div>

  <!-- JS: logic, UX, persistence, prompt generation -->
  <script>
    (function () {
      // ---------- Helpers ----------
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

      function toPersian(num){
        const map = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
        return String(num).replace(/\d/g, d => map[d]);
      }

      // ---------- State ----------
      const state = {
        step: 1,
        total: 4,
        data: {
          task: '',
          energy: 5,
          mood: 'Ø®Ø³ØªÙ‡',
          time: 'Û± Ø³Ø§Ø¹Øª',
          barrier: 'Ú¯ÙˆØ´ÛŒ',
          createdAt: new Date().toISOString()
        },
        autosaveTimer: null
      };

      // ---------- Elements ----------
      const stepPanels = $$('.step-panel');
      const stepDots = $$('.step-dot');
      const progressBar = $('#progressBar');
      const currentStepNum = $('#currentStepNum');
      const prevBtn = $('#prevBtn');
      const nextBtn = $('#nextBtn');
      const generateBtn = $('#generateBtn');

      const taskInput = $('#taskInput');
      const taskButtons = $$('.task-btn');

      const energyRange = $('#energyRange');
      const energyValue = $('#energyValue');
      const moodBtns = $$('.mood-btn');

      const timeRadios = $$('input[name="time"]');
      const barrierRadios = $$('input[name="barrier"]');

      const resultSection = $('#resultSection');
      const promptOutput = $('#promptOutput');
      const copyBtn = $('#copyBtn');
      const shareBtn = $('#shareBtn');
      const resetBtn = $('#resetBtn');

      const saveIndicator = $('#saveIndicator');

      // ---------- Load / Save ----------
      const STORAGE_KEY = 'quickplan_v2';
      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const parsed = JSON.parse(raw);
            Object.assign(state.data, parsed);
            // ensure defaults
            if(!state.data.mood) state.data.mood = 'Ø®Ø³ØªÙ‡';
            if(!state.data.energy) state.data.energy = 5;
          }
        }catch(e){}
      }

      function saveState(showToast = true){
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
          if(showToast){
            showSaved();
          }
        }catch(e){}
      }

      // autosave debounce
      function scheduleSave(){
        if(state.autosaveTimer) clearTimeout(state.autosaveTimer);
        state.autosaveTimer = setTimeout(()=> saveState(true), 700);
      }

      // ---------- UI: steps ----------
      function renderStep(){
        stepPanels.forEach(p => p.classList.add('hidden'));
        const active = document.querySelector('.step-panel[data-step="'+state.step+'"]');
        if(active) active.classList.remove('hidden');

        // dots and progress
        stepDots.forEach((d,i) => {
          d.classList.toggle('bg-emerald-500', i < state.step);
          d.classList.toggle('bg-gray-600', i >= state.step);
        });
        const pct = clamp((state.step / state.total) * 100, 0, 100);
        progressBar.style.width = pct + '%';
        currentStepNum.textContent = toPersian(state.step);

        prevBtn.classList.toggle('hidden', state.step === 1);
        nextBtn.classList.toggle('hidden', state.step === state.total);
        generateBtn.classList.toggle('hidden', state.step !== state.total);
      }

      // ---------- Bind interactions ----------
      // task input
      taskInput.value = state.data.task || '';
      taskInput.addEventListener('input', e => {
        state.data.task = e.target.value.trim();
        scheduleSave();
      });

      // preset task buttons
      taskButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          taskButtons.forEach(b => b.classList.remove('selected', 'bg-emerald-500', 'text-white'));
          btn.classList.add('selected', 'bg-emerald-500', 'text-white');
          const v = btn.dataset.value || '';
          state.data.task = v;
          taskInput.value = v;
          scheduleSave();
        });
      });

      // energy
      energyRange.value = state.data.energy;
      energyValue.textContent = toPersian(state.data.energy);
      energyRange.addEventListener('input', (e) => {
        const v = Number(e.target.value);
        state.data.energy = clamp(v, 1, 10);
        energyValue.textContent = toPersian(state.data.energy);
        scheduleSave();
      });

      // mood
      moodBtns.forEach(b => {
        if(b.dataset.mood === state.data.mood) b.classList.add('selected','bg-emerald-500','text-white');
        b.addEventListener('click', () => {
          moodBtns.forEach(x => x.classList.remove('selected','bg-emerald-500','text-white'));
          b.classList.add('selected','bg-emerald-500','text-white');
          state.data.mood = b.dataset.mood;
          scheduleSave();
        });
      });

      // time radios
      timeRadios.forEach(r => {
        if(r.value === state.data.time) r.checked = true;
        r.addEventListener('change', (e)=> {
          if(e.target.checked) {
            state.data.time = e.target.value;
            scheduleSave();
          }
        });
      });

      // barrier radios
      barrierRadios.forEach(r => {
        if(r.value === state.data.barrier) r.checked = true;
        r.addEventListener('change', (e)=> {
          if(e.target.checked) {
            state.data.barrier = e.target.value;
            scheduleSave();
          }
        });
      });

      // nav buttons
      nextBtn.addEventListener('click', ()=> {
        if(state.step < state.total){
          state.step++;
          renderStep();
          window.scrollTo({top:0,behavior:'smooth'});
        }
      });
      prevBtn.addEventListener('click', ()=> {
        if(state.step > 1){
          state.step--;
          renderStep();
          window.scrollTo({top:0,behavior:'smooth'});
        }
      });

      generateBtn.addEventListener('click', ()=> generateAndShow());
      // also allow nextBtn to produce on last step (hidden logic)
      $('#nextBtn').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') $('#nextBtn').click(); });

      // reset
      resetBtn.addEventListener('click', ()=> {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      // copy & share
      copyBtn.addEventListener('click', async ()=> {
        try {
          await navigator.clipboard.writeText(promptOutput.textContent);
          flashCopy(copyBtn, 'Ú©Ù¾ÛŒ Ø´Ø¯');
        } catch(e){
          flashCopy(copyBtn, 'Ú©Ù¾ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
        }
      });

      shareBtn.addEventListener('click', ()=> {
        try{
          const s = btoa(encodeURIComponent(JSON.stringify(state.data)));
          const url = location.origin + location.pathname + '?s=' + s;
          navigator.clipboard.writeText(url).then(()=> flashCopy(shareBtn,'Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯'));
        }catch(e){
          flashCopy(shareBtn,'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú©');
        }
      });

      function flashCopy(el, msg){
        const original = el.innerHTML;
        el.innerHTML = msg;
        setTimeout(()=> el.innerHTML = original, 1500);
      }

      // show saved indicator
      function showSaved(){
        saveIndicator.style.opacity = '1';
        setTimeout(()=> saveIndicator.style.opacity = '0', 1200);
      }

      // ---------- Prompt generation logic ----------
      function moodHint(mood){
        const map = {
          'Ø¹Ø§Ù„ÛŒ':'Ù¾Ø± Ø§Ù†Ø±Ú˜ÛŒ â€” Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ú©Ø§Ø± Ú†Ø§Ù„Ø´ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ø§Ø¯.',
          'Ù…Ø¹Ù…ÙˆÙ„ÛŒ':'Ø§Ù†Ø±Ú˜ÛŒ Ù…ØªÙˆØ³Ø· â€” Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯ Ø¨Ø§ ÙˆÙ‚ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ù…Ù†Ø§Ø³Ø¨Ù†Ø¯.',
          'Ø®Ø³ØªÙ‡':'Ú©Ù… Ø§Ù†Ø±Ú˜ÛŒ â€” Ø¨Ù‡ØªØ± Ø§Ø³Øª Ú©Ø§Ø±Ù‡Ø§ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø±ÙØªØ§Ø±ÛŒ Ø¨Ø§Ø´Ù†Ø¯.',
          'Ø§Ø³ØªØ±Ø³ÛŒ':'Ù…Ø¶Ø·Ø±Ø¨ â€” Ø§Ø¨ØªØ¯Ø§ ØªÙ…Ø±ÛŒÙ† Ú©ÙˆÚ†Ú© Ø±ÛŒÙ„Ú©Ø³ÛŒØ´Ù†ØŒ Ø³Ù¾Ø³ Ú©Ø§Ø± Ú©ÙˆØªØ§Ù‡.'
        };
        return map[mood] || '';
      }

      function planForEnergyTime(task, energy, time){
        // returns [startImmediate, planLinesArray, ifThen, emergency]
        // Normalize time token
        const t = String(time);
        let bucket = 'hour';
        if(t.includes('Û±Ûµ') || t.includes('Û±Ûµ-Û³Û°') || t.includes('15')) bucket = 'short';
        if(t.includes('Û²') || t.includes('+') || t.includes('2')) bucket = 'long';
        // energy ranges
        const e = Number(energy);
        if(e <= 3){
          if(bucket === 'short') return [
            `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù†ÙØ³ Ø¹Ù…ÛŒÙ‚ â†’ 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø³Ø§Ø¯Ù‡ Ø±ÙˆÛŒ: ${task}`,
            [`10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø³Ø§Ø¯Ù‡ Ø±ÙˆÛŒ ÛŒÚ© Ø²ÛŒØ±Ú©Ø§Ø± Ù…Ø´Ø®Øµ Ø§Ø² "${task}"`],
            `If-Then: Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ø®Ø§Ù…ÙˆØ´ ÛŒØ§ Ø¯ÙˆØ± Ø¨Ú¯Ø°Ø§Ø±.`,
            `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ±ÛŒÙ† Ù‚Ø¯Ù… Ù…Ù…Ú©Ù†.`
          ];
          if(bucket === 'hour') return [
            `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ â†’ 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø³ÛŒØ§Ø± Ø³Ø§Ø¯Ù‡ Ø±ÙˆÛŒ ${task}`,
            [`20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø§ ØªØ§ÛŒÙ…Ø± 20/5 (Ù¾ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ Ø³Ø§Ø¯Ù‡)`],
            `If-Then: Ø§Ú¯Ø± Ø®Ø³ØªÙ‡ Ø´Ø¯ÛŒ â†’ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª ÙØ¹Ø§Ù„.`,
            `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø§ Ù‡Ø¯Ù Ú©Ø§Ù‡Ø´ Ø­Ø¬Ù… ÛµÛ°Ùª.`
          ];
          return [
            `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· â†’ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ú©ÙˆØªØ§Ù‡ Ø±ÙˆÛŒ ${task}`,
            [`30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¯Ùˆ Ù¾Ø§Ø±Øª 15/5`],
            `If-Then: Ø§Ú¯Ø± ÙˆØ³ÙˆØ³Ù‡ Ø´Ø¯ÛŒ â†’ ØªØ§ÛŒÙ…Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª.`,
            `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Ø¬Ù„Ø³Ù‡Ù” 15 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ù‡Ø¯Ù ÙÙ‚Ø· Ù¾ÛŒØ´â€ŒØ±ÙˆÛŒ Ú©ÙˆÚ†Ú©.`
          ];
        }

        if(e <= 6){
          if(bucket === 'short') return [
            `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 30 Ø«Ø§Ù†ÛŒÙ‡ Ù‡Ø¯Ùâ€ŒÚ¯Ø°Ø§Ø±ÛŒ â†’ 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ ${task}`,
            [`15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² Ùˆ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ±`],
            `If-Then: Ø¯Ø± ØµÙˆØ±Øª Ù…Ø²Ø§Ø­Ù…Øª â†’ Ù‡Ø¯ÙÙˆÙ† ÛŒØ§ Ù…Ø­ÛŒØ· Ø¢Ø±Ø§Ù….`,
            `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Ù‡Ù…Ø§Ù† 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø±Ø§ Ø¨Ù‡ 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ù‡Ø´ Ø¨Ø¯Ù‡.`
          ];
          if(bucket === 'hour') return [
            `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‡Ø¯Ùâ€ŒÚ¯Ø°Ø§Ø±ÛŒ â†’ 45 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø§ ØªÙ…Ø±Ú©Ø²`,
            [`45 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù‡Ø¯ÙÙ…Ù†Ø¯ + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ±`],
            `If-Then: Ø§Ú¯Ø± ØªÙ…Ø±Ú©Ø² Ù¾Ø±ÛŒØ¯ â†’ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±ÛŒÙ† ØªÙ†ÙØ³ÛŒ Ø³Ù¾Ø³ Ø§Ø¯Ø§Ù…Ù‡.`,
            `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´.`
          ];
          return [
            `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ â†’ 90 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø³Ø§Ø®ØªØ§Ø±ÛŒ`,
            [`90 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ 3 Ø¨Ø®Ø´ 30 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ`],
            `If-Then: Ø¯Ø± ØµÙˆØ±Øª ÙˆÙ‚ÙÙ‡ â†’ Ø¨Ø®Ø´ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ù‡ 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ù‡Ø´ Ø¨Ø¯Ù‡.`,
            `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” ÙØ´Ø±Ø¯Ù‡ Ø¨Ø§ 1 Ù‡Ø¯Ù.`
          ];
        }

        // high energy
        if(bucket === 'short') return [
          `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 30 Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ â†’ 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÙØ± Ø§Ù†Ø±Ú˜ÛŒ Ø±ÙˆÛŒ ${task}`,
          [`20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø´Ø®Øµ`],
          `If-Then: Ú¯ÙˆØ´ÛŒ Ø¯Ø± Ø­Ø§Ù„Øª Do Not Disturb.`,
          `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 20 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±Ú©Ø² Ú©Ø§Ù…Ù„.`
        ];
        if(bucket === 'hour') return [
          `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ¹ÛŒÛŒÙ† Ù‡Ø¯Ù â†’ 90 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¹Ù…ÛŒÙ‚ (50/10/30)`,
          [`60 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª + 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ±`],
          `If-Then: Ø¯Ø± ØµÙˆØ±Øª Ù…Ø²Ø§Ø­Ù…Øª Ø¨Ø²Ø±Ú¯ â†’ Ø§Ù†ØªÙ‚Ø§Ù„ Ú©Ø§Ø± Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø¯ÛŒÚ¯Ø±.`,
          `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 40 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ú©Ø§Ù…Ù„.`
        ];
        return [
          `Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ â†’ 2+ Ø³Ø§Ø¹Øª Ø¨Ù„ÙˆÚ© Ø¹Ù…ÛŒÙ‚`,
          [`2 Ø³Ø§Ø¹Øª ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ 2 Ø¬Ù„Ø³Ù‡ 50 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ`],
          `If-Then: Ø§Ú¯Ø± ØªÙ…Ø±Ú©Ø² Ø§ÙØªØ§Ø¯ â†’ 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¯Ù… Ø²Ø¯Ù† Ùˆ Ø¨Ø±Ú¯Ø´Øª.`,
          `Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 60 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø´Ø®Øµ.`
        ];
      }

      function buildPrompt(){
        // ensure data
        const d = state.data;
        const task = d.task && d.task.length ? d.task : (['ÛŒÚ©Ù… Ø¯Ø±Ø³ Ø¨Ø®ÙˆÙ†Ù…','Ú©Ø§Ø±Ø§Ù… Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù…','ÙˆØ±Ø²Ø´ Ú©Ù†Ù…','Ø®ÙˆÙ†Ù‡ Ø±Ùˆ Ù…Ø±ØªØ¨ Ú©Ù†Ù…'][Math.floor(Math.random()*4)]);
        const moodText = moodHint(d.mood);
        const plan = planForEnergyTime(task, d.energy, d.time);
        const immediate = plan[0];
        const steps = plan[1];
        const ifthen = plan[2];
        const emergency = plan[3];

        const promptLines = [];

        promptLines.push(`# âš¡ Ø§Ù„Ø§Ù† Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø´Ø±ÙˆØ¹ Ú©Ù†Ù…`);
        promptLines.push(`## ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ù…Ù†:`);
        promptLines.push(`- Ú©Ø§Ø±: ${task}`);
        promptLines.push(`- Ø§Ù†Ø±Ú˜ÛŒ: ${toPersian(d.energy)}/Û±Û°`);
        promptLines.push(`- Ø­Ø§Ù„: ${d.mood} â€” ${moodText}`);
        promptLines.push(`- ÙˆÙ‚Øª: ${d.time}`);
        promptLines.push(`- Ù…Ø§Ù†Ø¹ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: ${d.barrier}`);
        promptLines.push('');
        promptLines.push(`## ğŸ¯ Ø§Ø²Øª Ù…ÛŒâ€ŒØ®ÙˆØ§Ù…:`);
        promptLines.push(`ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” **Ø¹Ù…Ù„ÛŒØŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§** Ø¨Ø¯Ù‡ Ú©Ù‡ Ù…Ù† Ø§Ø² Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø¨ØªÙˆÙ†Ù… Ø´Ø±ÙˆØ¹ Ú©Ù†Ù….`);
        promptLines.push('');
        promptLines.push(`## âœ… Ø®Ø±ÙˆØ¬ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± (Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ):`);
        promptLines.push(`1) Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ (Û³Û° Ø«Ø§Ù†ÛŒÙ‡ Ø§ÙˆÙ„): ${immediate}`);
        promptLines.push(`2) Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ (Ù…Ø±ØªØ¨ØŒ Ù‚Ø¯Ù…â€ŒØ¨Ù‡â€ŒÙ‚Ø¯Ù…):`);
        steps.forEach((s,i)=> promptLines.push(`${i+1}. ${s}`));
        promptLines.push(`3) If-Then Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¹ "${d.barrier}": ${ifthen}`);
        promptLines.push(`4) Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ (Ø§Ú¯Ø± ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù†Ø´Ø¯): ${emergency}`);
        promptLines.push('');
        promptLines.push(`**ØªØ°Ú©Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª:** Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ú©ÙˆØªØ§Ù‡ØŒ ÙÙ‡Ø±Ø³Øªâ€ŒØ´Ø¯Ù‡ Ùˆ Ø¨Ø§ Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ Ùˆ Ø¢Ø±Ø§Ù… Ø¨Ø¯Ù‡Ø› Ù‡Ø± Ù‚Ø¯Ù… Ø²ÛŒØ± 15 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ¹Ø±ÛŒÙ Ø´ÙˆØ¯.`);

        return promptLines.join('\\n');
      }

      // ---------- Generate & Show ----------
      function generateAndShow(){
        // collect latest from UI (safety)
        state.data.task = taskInput.value.trim() || state.data.task;
        // ensure selected time & barrier saved
        const tr = $$('input[name="time"]:checked')[0];
        const br = $$('input[name="barrier"]:checked')[0];
        if(tr) state.data.time = tr.value;
        if(br) state.data.barrier = br.value;

        const prompt = buildPrompt();
        promptOutput.textContent = prompt;
        resultSection.classList.remove('hidden');
        saveState(true);
        // scroll to result
        resultSection.scrollIntoView({behavior:'smooth', block:'center'});
      }

      // ---------- Init ----------
      function initFromURL(){
        try{
          const p = new URLSearchParams(location.search);
          const s = p.get('s');
          if(s){
            const decoded = JSON.parse(decodeURIComponent(atob(s)));
            Object.assign(state.data, decoded);
            // set UI values after loading
            taskInput.value = state.data.task || '';
            energyRange.value = state.data.energy || 5;
            energyValue.textContent = toPersian(state.data.energy || 5);
            moodBtns.forEach(b => b.classList.toggle('selected', b.dataset.mood === state.data.mood));
            timeRadios.forEach(r => r.checked = (r.value === state.data.time));
            barrierRadios.forEach(r => r.checked = (r.value === state.data.barrier));
            showSaved();
            return true;
          }
        }catch(e){}
        return false;
      }

      function init(){
        // load local state then override with URL if exists
        loadState();
        initFromURL();

        // apply loaded state to UI
        taskInput.value = state.data.task || '';
        energyRange.value = state.data.energy || 5;
        energyValue.textContent = toPersian(state.data.energy || 5);
        moodBtns.forEach(b => b.classList.toggle('selected', b.dataset.mood === state.data.mood));
        timeRadios.forEach(r => r.checked = (r.value === state.data.time));
        barrierRadios.forEach(r => r.checked = (r.value === state.data.barrier));

        renderStep();
      }

      // keyboard nav
      window.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowRight') nextBtn.click();
        if(e.key === 'ArrowLeft') prevBtn.click();
        if(e.key === 'Enter' && state.step === state.total && !resultSection.classList.contains('hidden')) {
          // Enter copies prompt
          copyBtn.click();
        }
      });

      init();

    })();
  </script>

</body>
</html>
