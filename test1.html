<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ø§Ù„Ø§Ù† Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ â€” Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒØ³Ø§Ø² ÙÙˆØ±ÛŒ</title>

  <!-- Google Font (Vazirmatn) -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Minimal CSS (mobile-first, RTL aware) -->
  <style>
    :root{
      --bg-1: #0f172a;
      --bg-2: #0b1220;
      --card: rgba(255,255,255,0.95);
      --glass: rgba(255,255,255,0.06);
      --accent: #10b981;
      --accent-600: #059669;
      --muted: #94a3b8;
      --danger: #ef4444;
      --max-width: 720px;
      --radius: 14px;
      --gap: 14px;
      --fw: 'Vazirmatn', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--fw);
      background: linear-gradient(180deg,var(--bg-1) 0%, #0b1220 100%);
      color: #e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
      padding:18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:var(--max-width);
      margin: 8px;
    }

    header.app-header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-start;
      margin-bottom:10px;
    }
    .logo {
      width:56px;height:56px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,#059669,#10b981);
      box-shadow: 0 8px 24px rgba(2,6,23,0.6);
      font-weight:700;font-size:22px;
    }
    .title {
      display:flex;flex-direction:column;
    }
    .title h1{margin:0;font-size:18px;color:white}
    .title p{margin:0;font-size:12px;color:var(--muted);}

    main.card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:var(--radius);
      padding:16px;
      box-shadow: 0 20px 40px rgba(2,6,23,0.6);
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.03);
    }

    .stepper{
      display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.03);
      margin-bottom:12px;
    }
    .steps{
      display:flex;gap:8px;align-items:center;flex:1;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;background:#475569;display:inline-block;transition:transform .18s, background .18s;
    }
    .dot.active{background:var(--accent);transform:scale(1.25)}
    .progress{
      height:6px;background:rgba(255,255,255,0.04);border-radius:6px;flex:1;position:relative;overflow:hidden;
    }
    .progress .bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-600));width:0%;transition:width .35s ease}

    /* Step content */
    .step-content{padding-top:12px}
    .step-group{display:grid;gap:12px}
    label.field-label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], textarea {
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.02); color:#e6eef8;font-size:15px;outline:none;
    }
    input[type="text"]::placeholder, textarea::placeholder{color:rgba(230,238,248,0.45)}

    .options-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .option{
      background: rgba(255,255,255,0.02); border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:14px;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03); user-select:none;
      transition: transform .12s, background .12s, border-color .12s;
    }
    .option:hover{transform:translateY(-4px)}
    .option.selected{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white;border-color:transparent;box-shadow:0 10px 30px rgba(3,105,76,0.12)}

    /* energy slider */
    .energy-wrap{display:flex;flex-direction:column;gap:8px}
    .energy-track{height:10px;border-radius:10px;background:linear-gradient(90deg,#ef4444, #f59e0b, var(--accent));position:relative}
    input[type="range"]{appearance:none;width:100%;background:transparent;margin:0;padding:0}
    input[type="range"]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:white;border:3px solid var(--accent);box-shadow:0 4px 10px rgba(2,6,23,0.35)}
    .energy-value{font-weight:700;color:var(--accent);font-size:18px;text-align:center}

    /* time / barrier buttons - larger hit area for mobile */
    .radio-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .radio-card{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);text-align:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .radio-card.selected{background:linear-gradient(180deg,#f0fdf4,#ecfdf5);color:#064e3b;border-color:transparent;background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white}

    /* bottom nav */
    .nav-row{display:flex;gap:10px;margin-top:14px}
    .btn{
      flex:1;padding:12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;font-size:15px;
    }
    .btn.secondary{background:rgba(255,255,255,0.04);color:#e6eef8}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-600));color:white;box-shadow:0 12px 30px rgba(16,185,129,0.12)}

    /* result card */
    .result-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
    pre.prompt-output{white-space:pre-wrap;word-break:break-word;background:linear-gradient(180deg,#071329,#04131f);padding:12px;border-radius:10px;color:#9be7c4;font-size:13px;direction:ltr;text-align:left;overflow:auto;max-height:360px}

    .tiny{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .save-indicator{position:fixed;left:16px;bottom:18px;background:rgba(2,6,23,0.8);color:white;padding:8px 12px;border-radius:999px;font-size:13px;display:flex;align-items:center;gap:8px;box-shadow:0 12px 30px rgba(2,6,23,0.6)}
    .hidden{display:none}

    footer.hint{margin-top:12px;font-size:12px;color:var(--muted);text-align:center}

    /* Responsive */
    @media (max-width:520px){
      .options-grid{grid-template-columns:repeat(4,1fr)}
      .radio-grid{grid-template-columns:repeat(2,1fr)}
      .title h1{font-size:16px}
    }

    /* Accessibility focus */
    .option:focus, .radio-card:focus, .btn:focus{outline:3px solid rgba(16,185,129,0.14);outline-offset:3px}
  </style>
</head>
<body>
  <div class="container" role="application" aria-labelledby="appTitle">
    <header class="app-header">
      <div class="logo" aria-hidden="true">âš¡</div>
      <div class="title">
        <h1 id="appTitle">Ø§Ù„Ø§Ù† Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ â€” Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒØ³Ø§Ø² ÙÙˆØ±ÛŒ</h1>
        <p class="tiny">Ø¯Ø± Û´ Ù…Ø±Ø­Ù„Ù‡ØŒ ÛŒÚ© Ù¾Ø±Ø§Ù…Ù¾Øª Ø¹Ù…Ù„ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø±Ø§ÛŒ ChatGPT Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… â€” Ø³Ø±ÛŒØ¹ Ùˆ Ù…Ø´Ø®Øµ.</p>
      </div>
    </header>

    <main class="card" id="appCard" aria-live="polite">
      <!-- Stepper -->
      <div class="stepper" aria-hidden="false">
        <div class="steps" aria-hidden="true">
          <span class="dot" data-step="1"></span>
          <span class="dot" data-step="2"></span>
          <span class="dot" data-step="3"></span>
          <span class="dot" data-step="4"></span>
        </div>
        <div class="progress" aria-hidden="true" title="Ù¾ÛŒØ´Ø±ÙØª">
          <div class="bar" id="progressBar" style="width:25%"></div>
        </div>
      </div>

      <!-- Step container -->
      <section class="step-content" id="stepsContainer">
        <!-- STEP 1 -->
        <div class="step" data-step="1">
          <div class="step-group">
            <div>
              <label class="field-label">Û± Â· Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ú†ÛŒÚ©Ø§Ø± Ú©Ù†ÛŒØŸ</label>
              <input id="taskInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯Ø±Ø³ Ø®ÙˆÙ†Ø¯Ù† ØªÙ…Ø±Ú©Ø± Ø±ÙˆÛŒ ÛŒÚ© ÙØµÙ„..." aria-label="Ø´Ø±Ø­ Ú©Ø§Ø±" />
              <p class="tiny muted" id="taskHint">Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ù‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ.</p>
            </div>

            <div>
              <label class="field-label">Ù‚Ø§Ù„Ø¨ Ø³Ø±ÛŒØ¹</label>
              <div class="options-grid" role="list" aria-label="Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§">
                <div class="option" tabindex="0" data-emoji="ğŸ“š" data-task="Ø¯Ø±Ø³ Ø®ÙˆØ§Ù†Ø¯Ù†" role="button">ğŸ“š<div class="tiny">Ø¯Ø±Ø³</div></div>
                <div class="option" tabindex="0" data-emoji="ğŸ’¼" data-task="Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø§Ø¯Ø§Ø±ÛŒ" role="button">ğŸ’¼<div class="tiny">Ú©Ø§Ø±</div></div>
                <div class="option" tabindex="0" data-emoji="ğŸƒ" data-task="ÙˆØ±Ø²Ø´ Ú©ÙˆØªØ§Ù‡" role="button">ğŸƒ<div class="tiny">ÙˆØ±Ø²Ø´</div></div>
                <div class="option" tabindex="0" data-emoji="ğŸ§¹" data-task="Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø®Ø§Ù†Ù‡" role="button">ğŸ§¹<div class="tiny">Ø®ÙˆÙ†Ù‡</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="step hidden" data-step="2">
          <div class="step-group">
            <div>
              <label class="field-label">Û² Â· Ø§Ù„Ø§Ù† Ú†Ù‚Ø¯Ø± Ø§Ù†Ø±Ú˜ÛŒ Ø¯Ø§Ø±ÛŒØŸ</label>
              <div class="energy-wrap" aria-hidden="false">
                <div class="energy-track" aria-hidden="true"></div>
                <input id="energyRange" type="range" min="1" max="10" value="5" aria-label="Ù…ÛŒØ²Ø§Ù† Ø§Ù†Ø±Ú˜ÛŒ">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span class="tiny">Ú©Ù…</span>
                  <div class="energy-value" id="energyValue">Ûµ</div>
                  <span class="tiny">Ø²ÛŒØ§Ø¯</span>
                </div>
              </div>
            </div>

            <div>
              <label class="field-label">Ø­Ø§Ù„ Ø±ÙˆØ­ÛŒ (Ù…ÙˆØ¯)</label>
              <div class="options-grid" role="list" aria-label="Ù…ÙˆØ¯Ù‡Ø§">
                <div class="option" tabindex="0" data-mood="Ø¹Ø§Ù„ÛŒ" role="button">ğŸ˜Š<div class="tiny">Ø¹Ø§Ù„ÛŒ</div></div>
                <div class="option" tabindex="0" data-mood="Ù…Ø¹Ù…ÙˆÙ„ÛŒ" role="button">ğŸ˜<div class="tiny">Ù…Ø¹Ù…ÙˆÙ„ÛŒ</div></div>
                <div class="option selected" tabindex="0" data-mood="Ø®Ø³ØªÙ‡" role="button">ğŸ˜”<div class="tiny">Ø®Ø³ØªÙ‡</div></div>
                <div class="option" tabindex="0" data-mood="Ø§Ø³ØªØ±Ø³ÛŒ" role="button">ğŸ˜°<div class="tiny">Ø§Ø³ØªØ±Ø³ÛŒ</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 3 -->
        <div class="step hidden" data-step="3">
          <div class="step-group">
            <div>
              <label class="field-label">Û³ Â· Ú†Ù‚Ø¯Ø± ÙˆÙ‚Øª Ø¯Ø§Ø±ÛŒØŸ</label>
              <div class="radio-grid" role="list">
                <div class="radio-card" tabindex="0" data-time="Û±Ûµ-Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡" role="radio" aria-checked="false">âš¡<div class="tiny">Û±Ûµâ€“Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡</div></div>
                <div class="radio-card selected" tabindex="0" data-time="Û± Ø³Ø§Ø¹Øª" role="radio" aria-checked="true">ğŸ•<div class="tiny">Û± Ø³Ø§Ø¹Øª</div></div>
                <div class="radio-card" tabindex="0" data-time="Û²+ Ø³Ø§Ø¹Øª" role="radio" aria-checked="false">ğŸ“…<div class="tiny">Û²+ Ø³Ø§Ø¹Øª</div></div>
              </div>
            </div>

            <div>
              <label class="field-label">Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ù… Ø¨Ø´Ù‡ØŸ</label>
              <div style="display:flex;gap:8px">
                <button class="btn secondary" id="prioNo" aria-pressed="false">Ù†Ù‡</button>
                <button class="btn primary" id="prioYes" aria-pressed="true">Ø¨Ù„Ù‡ØŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†</button>
              </div>
              <p class="tiny muted">Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† ÙˆØ¸Ø§ÛŒÙ Ø¯Ø± Ù‡Ù…Ø§Ù† Ø§Ø¨ØªØ¯Ø§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´ÙˆÙ†Ø¯.</p>
            </div>
          </div>
        </div>

        <!-- STEP 4 -->
        <div class="step hidden" data-step="4">
          <div class="step-group">
            <div>
              <label class="field-label">Û´ Â· Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø­ÙˆØ§Ø³Øª Ø±Ø§ Ù¾Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ</label>
              <div class="radio-grid">
                <div class="radio-card selected" tabindex="0" data-barrier="Ú¯ÙˆØ´ÛŒ">ğŸ“±<div class="tiny">Ú¯ÙˆØ´ÛŒ</div></div>
                <div class="radio-card" tabindex="0" data-barrier="Ø®Ø³ØªÚ¯ÛŒ">ğŸ˜´<div class="tiny">Ø®Ø³ØªÚ¯ÛŒ</div></div>
                <div class="radio-card" tabindex="0" data-barrier="Ø³Ø± Ùˆ ØµØ¯Ø§">ğŸ”Š<div class="tiny">Ø³Ø± Ùˆ ØµØ¯Ø§</div></div>
                <div class="radio-card" tabindex="0" data-barrier="Ø¨ÛŒâ€ŒØ­ÙˆØµÙ„Ú¯ÛŒ">ğŸ˜‘<div class="tiny">Ø¨ÛŒâ€ŒØ­ÙˆØµÙ„Ú¯ÛŒ</div></div>
              </div>
            </div>

            <div>
              <div class="result-preview result-card" id="livePreview" aria-live="polite">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div class="tiny muted">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø®Ø±ÙˆØ¬ÛŒ</div>
                    <div style="font-weight:700">Ø®Ù„Ø§ØµÙ‡Ù” Ú©ÙˆØªØ§Ù‡</div>
                  </div>
                  <div class="tiny muted">Ù‚Ø§Ø¨Ù„ Ú©Ù¾ÛŒ</div>
                </div>
                <div style="margin-top:8px" id="previewText">ÛŒÚ© Ø®Ù„Ø§ØµÙ‡Ù” Ú©ÙˆØªØ§Ù‡ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Nav -->
      <div class="nav-row" role="toolbar" aria-label="Ù†Ø§ÙˆØ¨Ø±ÛŒ">
        <button id="prevBtn" class="btn secondary" aria-hidden="true" disabled>â† Ù‚Ø¨Ù„ÛŒ</button>
        <button id="nextBtn" class="btn primary">Ø¨Ø¹Ø¯ÛŒ â†’</button>
      </div>

      <!-- Result panel (hidden until generated) -->
      <div id="resultWrap" class="hidden" style="margin-top:14px">
        <div class="result-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Ù¾Ø±Ø§Ù…Ù¾Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
              <div class="tiny muted">Ú©Ù¾ÛŒ Ú©Ù† Ùˆ Ø¯Ø± ChatGPT Ø¨Ú†Ø³Ø¨Ø§Ù†</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn secondary" id="copyPromptBtn">ğŸ“‹ Ú©Ù¾ÛŒ</button>
              <button class="btn primary" id="shareLinkBtn">ğŸ”— Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
            </div>
          </div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">

          <div style="display:flex;gap:12px;flex-direction:column">
            <div>
              <div class="tiny muted">Ø®Ù„Ø§ØµÙ‡Ù” ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§</div>
              <div style="font-weight:700" id="summaryLine">â€”</div>
            </div>

            <div>
              <div class="tiny muted">Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ ChatGPT (Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±)</div>
              <pre id="promptOutput" class="prompt-output" aria-label="Ø®Ø±ÙˆØ¬ÛŒ Ù¾Ø±Ø§Ù…Ù¾Øª"></pre>
            </div>

            <div style="display:flex;gap:8px">
              <button id="regenerateBtn" class="btn secondary">ğŸ” Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø³Ø§Ø²</button>
              <button id="resetBtn" class="btn primary">ğŸ”„ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
            </div>
          </div>
        </div>
      </div>

      <footer class="hint">Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ (template) Ø±Ø§ Ù‡Ù… Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ù….</footer>
    </main>

    <div id="saveIndicator" class="save-indicator hidden" role="status" aria-live="polite">
      <span style="width:8px;height:8px;border-radius:50%;background:var(--accent);display:inline-block"></span>
      Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯
    </div>
  </div>

  <!-- JavaScript: logic Ùˆ accessibility -->
  <script>
    (function(){
      // ====== Helpers ======
      const el = (sel) => document.querySelector(sel);
      const els = (sel) => Array.from(document.querySelectorAll(sel));

      const toPersian = (num) => {
        const map = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
        return String(num).replace(/\d/g, d => map[d]);
      };

      // Initial state
      const state = {
        step: 1,
        total: 4,
        data: {
          task: '',
          energy: 5,
          mood: 'Ø®Ø³ØªÙ‡',
          time: 'Û± Ø³Ø§Ø¹Øª',
          barrier: 'Ú¯ÙˆØ´ÛŒ',
          priority: true
        },
        autosaveTimeout: null
      };

      // Elements
      const steps = els('.step');
      const dots = els('.dot');
      const progressBar = el('#progressBar');
      const prevBtn = el('#prevBtn');
      const nextBtn = el('#nextBtn');
      const taskInput = el('#taskInput');
      const options = els('.option');
      const moodBtns = els('[data-mood]');
      const energyRange = el('#energyRange');
      const energyValue = el('#energyValue');
      const timeCards = els('.radio-card[data-time]');
      const barrierCards = els('.radio-card[data-barrier]');
      const prioYes = el('#prioYes');
      const prioNo = el('#prioNo');
      const livePreview = el('#previewText');
      const resultWrap = el('#resultWrap');
      const promptOutput = el('#promptOutput');
      const summaryLine = el('#summaryLine');
      const copyPromptBtn = el('#copyPromptBtn');
      const shareLinkBtn = el('#shareLinkBtn');
      const regenerateBtn = el('#regenerateBtn');
      const resetBtn = el('#resetBtn');
      const saveIndicator = el('#saveIndicator');

      // Load from URL params (share) or localStorage
      function loadStateFromURL(){
        try{
          const p = new URLSearchParams(location.search);
          const s = p.get('s');
          if(s){
            const data = JSON.parse(decodeURIComponent(atob(s)));
            Object.assign(state.data, data);
            showToast('ÙˆØ¶Ø¹ÛŒØª Ø§Ø² Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
            return true;
          }
        }catch(e){}
        return false;
      }
      function loadState(){
        if(loadStateFromURL()) return;
        try {
          const raw = localStorage.getItem('quickPrompt_v1');
          if(raw){
            Object.assign(state.data, JSON.parse(raw));
            showTinySave(true);
          }
        } catch(e){}
      }

      loadState();

      // ====== UI helpers ======
      function setStep(n){
        state.step = Math.max(1, Math.min(state.total, n));
        steps.forEach(s => s.classList.add('hidden'));
        const active = document.querySelector('.step[data-step="'+state.step+'"]');
        if(active) active.classList.remove('hidden');

        // dots
        dots.forEach((d,i) => d.classList.toggle('active', i === state.step-1));
        progressBar.style.width = ((state.step/state.total)*100) + '%';

        // nav buttons
        prevBtn.disabled = (state.step === 1);
        prevBtn.style.visibility = (state.step === 1) ? 'hidden' : 'visible';
        nextBtn.textContent = (state.step === state.total) ? 'Ø³Ø§Ø®ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª' : 'Ø¨Ø¹Ø¯ÛŒ â†’';
      }

      setStep(state.step);

      // ====== Bind inputs ======
      // task input
      taskInput.value = state.data.task || '';
      taskInput.addEventListener('input', e => {
        state.data.task = e.target.value;
        scheduleAutosave();
        updateLivePreview();
      });

      // options (templates)
      options.forEach(opt => {
        opt.addEventListener('click', () => {
          options.forEach(o=>o.classList.remove('selected'));
          opt.classList.add('selected');
          const t = opt.dataset.task;
          taskInput.value = t;
          state.data.task = t;
          scheduleAutosave();
          updateLivePreview();
        });
        opt.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') opt.click(); });
      });

      // mood
      moodBtns.forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.mood === state.data.mood);
        btn.addEventListener('click', () => {
          moodBtns.forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          state.data.mood = btn.dataset.mood;
          scheduleAutosave();
          updateLivePreview();
        });
      });

      // energy
      energyRange.value = state.data.energy;
      energyValue.textContent = toPersian(state.data.energy);
      energyRange.addEventListener('input', (e) => {
        state.data.energy = Number(e.target.value);
        energyValue.textContent = toPersian(state.data.energy);
        scheduleAutosave();
        updateLivePreview();
      });

      // time
      function selectTimeCard(card){
        timeCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        timeCards.forEach(c => c.setAttribute('aria-checked','false'));
        card.setAttribute('aria-checked','true');
        state.data.time = card.dataset.time;
        scheduleAutosave();
        updateLivePreview();
      }
      timeCards.forEach(c => {
        // initialize selection
        if(!c.classList.contains('selected') && c.dataset.time === state.data.time) c.classList.add('selected');
        c.addEventListener('click', ()=> selectTimeCard(c));
        c.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') selectTimeCard(c) });
      });

      // barrier
      function selectBarrierCard(card){
        barrierCards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        state.data.barrier = card.dataset.barrier;
        scheduleAutosave();
        updateLivePreview();
      }
      barrierCards.forEach(c=>{
        if(!c.classList.contains('selected') && c.dataset.barrier === state.data.barrier) c.classList.add('selected');
        c.addEventListener('click', ()=> selectBarrierCard(c));
        c.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') selectBarrierCard(c) });
      });

      // priority toggle
      prioYes.addEventListener('click', ()=> { state.data.priority = true; prioYes.setAttribute('aria-pressed','true'); prioNo.setAttribute('aria-pressed','false'); prioYes.classList.add('primary'); prioNo.classList.remove('primary'); scheduleAutosave(); updateLivePreview();});
      prioNo.addEventListener('click', ()=> { state.data.priority = false; prioYes.setAttribute('aria-pressed','false'); prioNo.setAttribute('aria-pressed','true'); prioNo.classList.add('primary'); prioYes.classList.remove('primary'); scheduleAutosave(); updateLivePreview();});
      // initialize style
      if(state.data.priority){
        prioYes.classList.add('primary');
        prioNo.classList.remove('primary');
      }else{
        prioNo.classList.add('primary');
        prioYes.classList.remove('primary');
      }

      // next / prev
      nextBtn.addEventListener('click', () => {
        if(state.step < state.total){
          setStep(state.step+1);
        }else{
          // generate
          generatePromptAndShow();
        }
      });
      prevBtn.addEventListener('click', () => setStep(state.step-1));

      // regenerate / reset
      regenerateBtn.addEventListener('click', () => generatePromptAndShow());
      resetBtn.addEventListener('click', () => {
        localStorage.removeItem('quickPrompt_v1');
        location.search = '';
        location.reload();
      });

      // copy prompt
      async function copyText(txt){
        try {
          await navigator.clipboard.writeText(txt);
          showToast('Ú©Ù¾ÛŒ Ø´Ø¯');
        } catch (e) {
          const ta = document.createElement('textarea');
          ta.value = txt; document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); showToast('Ú©Ù¾ÛŒ Ø´Ø¯'); } catch(e) { alert('Ú©Ù¾ÛŒ Ù†Ø´Ø¯'); }
          document.body.removeChild(ta);
        }
      }
      copyPromptBtn.addEventListener('click', ()=> copyText(promptOutput.textContent));

      // share link: encode state into URL
      shareLinkBtn.addEventListener('click', () => {
        try {
          const data = btoa(encodeURIComponent(JSON.stringify(state.data)));
          const url = location.origin + location.pathname + '?s=' + data;
          copyText(url);
          showToast('Ù„ÛŒÙ†Ú© ÙˆØ¶Ø¹ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯');
        } catch(e){
          showToast('Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú©');
        }
      });

      // autosave UI
      function showTinySave(show){
        saveIndicator.classList.toggle('hidden', !show);
        if(show){
          setTimeout(()=> saveIndicator.classList.add('hidden'), 1600);
        }
      }
      function scheduleAutosave(){
        if(state.autosaveTimeout) clearTimeout(state.autosaveTimeout);
        state.autosaveTimeout = setTimeout(()=>{
          try{
            localStorage.setItem('quickPrompt_v1', JSON.stringify(state.data));
            showTinySave(true);
          }catch(e){}
        }, 700);
      }

      // tiny toast using saveIndicator (re-use)
      function showToast(msg){
        saveIndicator.textContent = msg;
        saveIndicator.classList.remove('hidden');
        setTimeout(()=> saveIndicator.classList.add('hidden'), 1600);
      }

      // live preview: small summary
      function updateLivePreview(){
        const d = state.data;
        const line = `${d.task || 'â€”'} Â· Ø§Ù†Ø±Ú˜ÛŒ ${toPersian(d.energy)}/Û±Û° Â· Ø­Ø§Ù„: ${d.mood} Â· ÙˆÙ‚Øª: ${d.time} Â· Ù…Ø²Ø§Ø­Ù…: ${d.barrier}`;
        livePreview.textContent = line;
      }
      updateLivePreview();

      // ====== Prompt generation logic (smarter) ======
      function safeShortTask(task){
        if(!task) return 'ÛŒÚ© Ú©Ø§Ø± Ú©ÙˆØªØ§Ù‡';
        return task;
      }

      function planForEnergyTime(task, energy, time){
        // produce a short plan based on energy + time
        // conservative defaults
        if(/Û±Ûµ|Û±Ûµ-Û³?Û°|Û±Ûµâ€“Û³Û°|Û±Ûµâ€“Û³Û°/.test(time) || /Û±Ûµ/.test(time)) time = 'Û±Ûµ-Û³Û°';
        if(/Û±/.test(time) || /ÛŒÚ© Ø³Ø§Ø¹Øª|Û± Ø³Ø§Ø¹Øª/.test(time)) time = 'Û¶Û°';
        if(/\+/.test(time) || /Û²/.test(time)) time = '120+';

        // energy: 1-10
        if(energy <= 3){
          if(time === 'Û±Ûµ-Û³Û°') return [`Ø´Ø±ÙˆØ¹ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ†ÙØ³ Ùˆ 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø®ÛŒÙ„ÛŒ Ø³Ø§Ø¯Ù‡ Ø±ÙˆÛŒ Â«${task}Â»`, `If-Then: Ø§Ú¯Ø± ÙˆØ³ÙˆØ³Ù‡Ù” Ú¯ÙˆØ´ÛŒ Ø´Ø¯ÛŒ â†’ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ÙÙˆÚ©ÙˆØ³ Ø¨Ø§ ØªØ§ÛŒÙ…Ø±`];
          if(time === '60') return [`Û²Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² + 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª (ØªÚ©Ø±Ø§Ø± x1) â€” ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´ ${task}`,'If-Then: Ú¯ÙˆØ´ÛŒ Ø±ÙˆÛŒ Do Not Disturb'];
          return [`Ù¾Ù„Ø§Ù†: 50 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª â€” Ù‡Ø¯Ù: ÛŒÚ© Ø²ÛŒØ±Ù‚Ø·Ø¹Ù‡Ù” Ù…Ø´Ø®Øµ Ø§Ø² ${task}`, 'If-Then: Ø§Ú¯Ø± Ø®Ø³ØªÙ‡ Ø´Ø¯ÛŒ â†’ Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ'];
        }
        if(energy <= 6){
          if(time === 'Û±Ûµ-Û³Û°') return [`Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ ÛŒÚ© Ø²ÛŒØ±Ù…Ø·Ù„Ø¨ Ø§Ø² ${task}`, 'If-Then: Ø§Ú¯Ø± Ø¬Ø°Ø¨ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ Ø´Ø¯ÛŒ â†’ Ø¨Ù„Ø§Ú© Ø§Ù¾â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡'];
          if(time === '60') return [`Û´Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ± + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±ÛŒÙ† Ø¹Ù…Ù„ÛŒ`, 'If-Then: Ø§Ú¯Ø± Ø³Ø±ÙˆØµØ¯Ø§ Ø¨ÙˆØ¯ â†’ Ù‡Ø¯Ù ØµÙˆØªÛŒ (Ù‡Ø¯ÙÙˆÙ†)'];
          return [`Û±Û²Û° Ø¯Ù‚ÛŒÙ‚Ù‡: ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ 3 Ø¨Ø®Ø´ 40m (Ù‡Ø± Ø¨Ø®Ø´ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø´Ø®Øµ) + Ø§Ø³ØªØ±Ø§Ø­Øª`, 'If-Then: Ø§Ú¯Ø± Ø®Ø³ØªÙ‡ Ø¨ÙˆØ¯ÛŒ â†’ Ú©Ø§Ù‡Ø´ Û³Û°Ùª Ø­Ø¬Ù… Ú©Ø§Ø±'];
        }
        // high energy
        if(time === 'Û±Ûµ-Û³Û°') return [`Û±Ûµ-Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÙØ± Ø§Ù†Ø±Ú˜ÛŒ â€” ØªÙ…Ø±Ú©Ø² Ú©Ø§Ù…Ù„ Ø±ÙˆÛŒ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´ ${task}`, 'If-Then: Ø¯Ø± ØµÙˆØ±Øª ÙˆÙ‚ÙÙ‡ â†’ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª'];
        if(time === '60') return [`Û¹Û° Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±Ú©Ø² Ù¾ÛŒÙˆØ³ØªÙ‡: 60m Ú©Ø§Ø± + 10m Ø§Ø³ØªØ±Ø§Ø­Øª + 20m Ù…Ø±ÙˆØ± Ùˆ ØªÙ…Ø±ÛŒÙ†`, 'If-Then: Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¯Ø± Ø§ØªØ§Ù‚ Ø¯ÛŒÚ¯Ø± Ø¨Ú¯Ø°Ø§Ø±'];
        return [`Û²+ Ø³Ø§Ø¹Øª: Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ø¹Ù…ÛŒÙ‚ Ø´Ø§Ù…Ù„ 2 Ø¬Ù„Ø³Ù‡Ù” 50m + 2 Ø§Ø³ØªØ±Ø§Ø­Øª 10m + 20m Ù…Ø±ÙˆØ±`, 'If-Then: Ø§Ú¯Ø± Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨ÛŒâ€ŒØ§Ù†Ú¯ÛŒØ²Ù‡ Ø¨ÙˆØ¯ÛŒ â†’ Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ'];
      }

      function mapMoodAdvice(mood){
        const m = { 'Ø¹Ø§Ù„ÛŒ':'ØªÙˆ Ø§ÙˆÚ©ÛŒ Ù‡Ø³ØªÛŒØ› Ù…ÛŒØ´Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú†Ø§Ù„Ø´ÛŒ Ø¯Ø§Ø¯.','Ù…Ø¹Ù…ÙˆÙ„ÛŒ':'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØªÙˆØ³Ø· Ø¨Ø§ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ú©Ø§Ø±-Ø§Ø³ØªØ±Ø§Ø­Øª Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³Øª.','Ø®Ø³ØªÙ‡':'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø¨Ú© Ø¨Ø§ ØªØ§Ú©ÛŒØ¯ Ø±ÙˆÛŒ Ø´Ø±ÙˆØ¹ Ú©ÙˆÚ†Ú© Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.','Ø§Ø³ØªØ±Ø³ÛŒ':'Ú©Ø§Ø±Ù‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¢Ø±Ø§Ù…â€ŒØ¨Ø®Ø´ Ùˆ ØªØ§ÛŒÙ…â€ŒØ¨ÙØ±ÙÚ© Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'};
        return m[mood] || '';
      }

      function generatePromptText(){
        const d = state.data;
        const task = safeShortTask(d.task);
        const moodAdvice = mapMoodAdvice(d.mood);
        const plan = planForEnergyTime(task, d.energy, d.time);
        const ifthen = (Array.isArray(plan) && plan[1]) ? plan[1] : 'If-Then: ÛŒÚ© Ù‚Ø¯Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø±Øª Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ù….';
        const mainPlan = (Array.isArray(plan) && plan[0]) ? plan[0] : 'ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø´Ø®Øµ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡.';
        const emergency = (d.energy <= 3) ? 'Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒÙˆØ³ØªÙ‡ Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ ÛŒÚ© Ú©Ø§Ø± Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú©' : 'Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ú©Ø§Ø±Ù‡Ø§';

        // Build ChatGPT-friendly instruction (in Persian)
        const instruction = [
          `# âš¡ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ù…Ù†`,
          `- Ú©Ø§Ø±: ${task}`,
          `- Ø§Ù†Ø±Ú˜ÛŒ: ${toPersian(d.energy)}/Û±Û°`,
          `- Ù…ÙˆØ¯: ${d.mood}`,
          `- Ø²Ù…Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯: ${d.time}`,
          `- Ø§Ø­ØªÙ…Ø§Ù„ Ù…Ø²Ø§Ø­Ù…Øª: ${d.barrier}`,
          '',
          `## ğŸ¯ Ø§Ø² ØªÙˆ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… (Ù‡Ø¯Ù):`,
          `ÛŒÚ© **Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§** Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ùˆ Ø§Ù†Ø±Ú˜ÛŒ Ø¨Ø¯ÛŒ Ú©Ù‡ Ù…Ù† Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨ØªÙˆÙ†Ù… Ø§Ø¬Ø±Ø§Ø´ Ú©Ù†Ù….`,
          '',
          `## âœ… Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ù‚ÛŒÙ‚ (Ø³Ù‡ Ø¨Ø®Ø´):`,
          `1) Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ â€” Û³Û° Ø«Ø§Ù†ÛŒÙ‡ Ø§ÙˆÙ„ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ú†Ù‡ Ú©Ø§Ø± Ú©Ù†Ù…ØŸ`,
          `2) Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ â€” Ù‚Ø¯Ù… Ø¨Ù‡ Ù‚Ø¯Ù… (ØªÙˆØ¶ÛŒØ­ ÙˆØ¸Ø§ÛŒÙ Ùˆ Ù…Ø¯Øª Ù‡Ø± Ù‚Ø¯Ù…).`,
          `3) If-Then Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¹ "${d.barrier}" Ùˆ ÛŒÚ© Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ.`,
          '',
          `## ğŸ’¡ Ù†Ú©Ø§Øª Ø§Ø¬Ø±Ø§ÛŒÛŒ:`,
          `- Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù…ÙˆØ¯: ${moodAdvice}`,
          `- Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù† (Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÙˆÛŒØª: ${d.priority ? 'Ø¨Ù„Ù‡' : 'Ù†Ù‡'})`,
          '',
          `## ğŸ§¾ Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (Ø®Ù„Ø§ØµÙ‡Ù” Ø³Ø±ÛŒØ¹):`,
          `- ${mainPlan}`,
          `- ${ifthen}`,
          `- Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: ${emergency}`,
          '',
          `---`,
          `Ù„Ø·ÙØ§Ù‹ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Ù…Ø®ØªØµØ± Ùˆ ÙÙ‡Ø±Ø³Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ø¯Ù‡ ØªØ§ Ù…Ù† Ø³Ø±ÛŒØ¹ Ú©Ù¾ÛŒ Ùˆ Ø§Ø¬Ø±Ø§ Ú©Ù†Ù….`
        ].join('\\n');

        return { raw: instruction, shortSummary: `${task} Â· Ø§Ù†Ø±Ú˜ÛŒ ${toPersian(d.energy)}/Û±Û° Â· ${d.time} Â· ${d.mood}` };
      }

      // Generate & show
      function generatePromptAndShow(){
        const out = generatePromptText();
        promptOutput.textContent = out.raw;
        summaryLine.textContent = out.shortSummary;
        resultWrap.classList.remove('hidden');
        // scroll to result
        resultWrap.scrollIntoView({behavior:'smooth', block:'center'});
        // save
        try{ localStorage.setItem('quickPrompt_v1', JSON.stringify(state.data)); showTinySave(true); }catch(e){}
      }

      // initial preview
      updateLivePreview();

      // Accessibility: keyboard shortcuts (n/p)
      window.addEventListener('keydown', (e)=> {
        if(e.key === 'ArrowRight') nextBtn.click();
        if(e.key === 'ArrowLeft') prevBtn.click();
      });

      // Initialize UI from loaded state
      (function initFromState(){
        // update selected options based on state.data
        if(state.data.task){
          // mark matching option if matches exactly
          options.forEach(o=> { if(o.dataset.task === state.data.task) o.classList.add('selected'); });
          taskInput.value = state.data.task;
        }
        energyRange.value = state.data.energy;
        energyValue.textContent = toPersian(state.data.energy);
        moodBtns.forEach(b => b.classList.toggle('selected', b.dataset.mood === state.data.mood));
        timeCards.forEach(c => c.classList.toggle('selected', c.dataset.time === state.data.time));
        barrierCards.forEach(c => c.classList.toggle('selected', c.dataset.barrier === state.data.barrier));
        updateLivePreview();
      })();

      // final: show tiny hint
      setTimeout(()=> el('.tiny').style.opacity = 1, 400);

    })();
  </script>
</body>
</html>
