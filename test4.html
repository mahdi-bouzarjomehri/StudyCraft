<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ø§Ù„Ø§Ù† Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ â€” Ø§Ù¾ Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ (Mobile)</title>

  <!-- Tailwind CDN (mobile-first utilities) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent: #06b6a4; /* teal-400 */
      --accent-600: #059669;
      --bg-dark: #071129;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Vazirmatn", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#071029 0%, #0b1220 60%);
      color: #0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    /* Mobile container */
    .app {
      width:100%;
      max-width:460px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
      border-radius:18px;
      box-shadow: 0 20px 60px rgba(2,6,23,0.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:640px;
    }

    /* Header */
    .app-header{
      padding:16px;
      background: linear-gradient(90deg,var(--accent),var(--accent-600));
      color:white;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;background:rgba(255,255,255,0.12)
    }

    /* Content */
    .app-body{padding:14px;flex:1;overflow:auto}
    .step-card{
      background: linear-gradient(180deg, #ffffff, #fbfbff);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.06);
    }

    /* Progress */
    .progress-track{height:8px;background:#e6eef8;border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-600));width:0%;transition:width .35s ease}

    /* Inputs */
    .input-field{border:1px solid #e6eef8;padding:12px;border-radius:12px;width:100%;background:transparent;font-size:15px}
    .option {border:1px solid #e6eef8;border-radius:12px;padding:12px;text-align:center;cursor:pointer}
    .option.selected{background:linear-gradient(90deg,var(--accent),var(--accent-600));color:white;border-color:transparent;box-shadow:0 10px 30px rgba(6,182,160,0.12)}
    .small{font-size:13px;color:#64748b}

    /* prompt output */
    .prompt-box{background:#061225;color:#9ee9cf;padding:12px;border-radius:10px;font-family: "Vazirmatn", ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px;white-space:pre-wrap}

    /* floating nav */
    .nav {
      display:flex;
      gap:10px;
      padding:12px;
      border-top:1px solid rgba(11,17,32,0.04);
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
    }
    .btn {
      flex:1;
      padding:12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      border:0;
    }
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(6,182,160,0.12)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-600));color:white;box-shadow:0 12px 30px rgba(6,182,160,0.12)}

    /* small helpers */
    .muted{color:#6b7280;font-size:13px}
    .center{text-align:center}

    /* accessible focus */
    .option:focus,.btn:focus,.input-field:focus{outline:3px solid rgba(6,182,160,0.12);outline-offset:2px}

    /* responsive */
    @media (min-width:520px){
      body{padding:30px}
      .app{transform:scale(1);max-width:520px}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="appTitle">
    <!-- Header -->
    <div class="app-header">
      <div class="logo" aria-hidden="true">âš¡</div>
      <div>
        <div id="appTitle" class="text-lg font-bold">Ø§Ù„Ø§Ù† Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ</div>
        <div class="small">Û´ Ù…Ø±Ø­Ù„Ù‡ â€” Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” ÙÙˆØ±ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§</div>
      </div>
    </div>

    <!-- Body -->
    <div class="app-body" id="appBody">
      <!-- Progress -->
      <div class="mb-3">
        <div class="flex items-center justify-between mb-2">
          <div class="small">Ù…Ø±Ø­Ù„Ù‡ <span id="stepNum">1</span> Ø§Ø² 4</div>
          <div class="small muted" id="liveHint">Ø´Ø±ÙˆØ¹ Ú©Ù† â€” Ø­ØªÛŒ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§ÙÛŒ Ø§Ø³Øª</div>
        </div>
        <div class="progress-track">
          <div id="progressBar" class="progress-bar" style="width:25%"></div>
        </div>
      </div>

      <!-- Step content (Wizard panels) -->
      <div id="wizard" class="space-y-4">
        <!-- Warm Start: brief motivation + micro-pledge -->
        <section class="step-card" data-step="0" aria-hidden="false">
          <div class="center mb-2">
            <div class="text-xl font-semibold">Ø´Ø±ÙˆØ¹ Ø¢Ø³Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† ÙØ´Ø§Ø±</div>
            <div class="muted mt-1">Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø³ÛŒ Ø§Ø³Øª Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø§Ø² ØµÙØ± Ø´Ø±ÙˆØ¹ Ú©Ù†Ø¯. ÙÙ‚Ø· Û± Ø§Ù‚Ø¯Ø§Ù… Ú©ÙˆÚ†Ú© Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡.</div>
          </div>

          <div class="mt-3">
            <div class="small mb-1">Ø¢ÛŒØ§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø´Ø±ÙˆØ¹ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú©ØŸ</div>
            <div class="grid grid-cols-2 gap-3">
              <button id="pledgeYes" class="btn primary" aria-pressed="false">Ø¢Ø±Ù‡ØŒ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù…</button>
              <button id="pledgeNo" class="btn ghost" aria-pressed="false">ÙØ¹Ù„Ø§Ù‹ Ù†Ù‡</button>
            </div>
          </div>

          <div class="mt-4 small muted">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ø§Ù„Ø§Ù† Â«Ù†Ù‡Â» Ø²Ø¯ÛŒØŒ ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†: Û² Ø¯Ù‚ÛŒÙ‚Ù‡ â€” Ù‡ÛŒÚ† Ú†ÛŒØ² Ø§Ø² Ø¯Ø³Øª Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒ.</div>
        </section>

        <!-- Step 1: Task (very small, behavior-based) -->
        <section class="step-card hidden" data-step="1" aria-hidden="true">
          <div class="center mb-2">
            <div class="text-lg font-semibold">Û± â€” Ú©Ø§Ø± Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</div>
            <div class="muted mt-1">ÛŒÚ© Ú©Ø§Ø± Ú©Ù‡ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù‡Ù…ÛŒÙ† Ø§Ù„Ø¢Ù† Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒ.</div>
          </div>

          <div class="mt-3">
            <label class="small mb-1 block">ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ú©Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹: Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø®ÙˆØ§Ù†Ø¯Ù† ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù)</label>
            <input id="taskInput" class="input-field" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù..." aria-label="ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ø±" />
            <div class="mt-3 small mb-1">Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</div>
            <div class="grid grid-cols-3 gap-2 mt-1">
              <div tabindex="0" role="button" class="option center" data-val="Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡">ğŸ“˜<div class="small muted">Ù…Ø·Ø§Ù„Ø¹Ù‡ Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡</div></div>
              <div tabindex="0" role="button" class="option center" data-val="Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±ÛŒÙ†">ğŸ‹ï¸â€â™‚ï¸<div class="small muted">Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±ÛŒÙ†</div></div>
              <div tabindex="0" role="button" class="option center" data-val="Û²Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø¯Ù†ÙˆÛŒØ³ÛŒ">ğŸ’»<div class="small muted">Û²Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø¯</div></div>
            </div>

            <div class="mt-3 small muted">Ù†Ú©ØªÙ‡: Ú©Ø§Ø± Ø±Ø§ ØªØ§ Ø­Ø¯ Ù…Ù…Ú©Ù† Ú©ÙˆÚ†Ú© Ú©Ù† â€” Ø´Ø±ÙˆØ¹ Ù…Ù‡Ù…â€ŒØªØ± Ø§Ø² Ú©Ø§Ù…Ù„ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù† Ø§Ø³Øª.</div>
          </div>
        </section>

        <!-- Step 2: Energy & Mood -->
        <section class="step-card hidden" data-step="2" aria-hidden="true">
          <div class="center mb-2">
            <div class="text-lg font-semibold">Û² â€” Ø§Ù†Ø±Ú˜ÛŒ Ùˆ Ø­Ø§Ù„Ù ÙØ¹Ù„ÛŒ</div>
            <div class="muted mt-1">Ø§ÛŒÙ† Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª ÙˆØ§Ù‚Ø¹ÛŒâ€ŒØ§Øª Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯.</div>
          </div>

          <div class="mt-3">
            <label class="small mb-1 block">Ø§Ù†Ø±Ú˜ÛŒÙ Ø§Ù„Ø§Ù†</label>
            <input id="energyRange" type="range" min="1" max="10" value="5" class="w-full" aria-label="Ø§Ù†Ø±Ú˜ÛŒ"/>
            <div class="flex items-center justify-between mt-1">
              <div class="small muted">Ú©Ù…</div>
              <div id="energyVal" class="font-bold">Ûµ</div>
              <div class="small muted">Ø²ÛŒØ§Ø¯</div>
            </div>
          </div>

          <div class="mt-4">
            <label class="small mb-1 block">Ø­Ø§Ù„Øª Ø±ÙˆØ­ÛŒ Ø§Ù„Ø§Ù†</label>
            <div class="grid grid-cols-4 gap-2">
              <div tabindex="0" role="button" class="option center" data-mood="Ø¹Ø§Ù„ÛŒ">ğŸ˜Š<div class="small muted">Ø¹Ø§Ù„ÛŒ</div></div>
              <div tabindex="0" role="button" class="option center" data-mood="Ù…Ø¹Ù…ÙˆÙ„ÛŒ">ğŸ˜<div class="small muted">Ù…Ø¹Ù…ÙˆÙ„ÛŒ</div></div>
              <div tabindex="0" role="button" class="option center selected" data-mood="Ø®Ø³ØªÙ‡">ğŸ˜”<div class="small muted">Ø®Ø³ØªÙ‡</div></div>
              <div tabindex="0" role="button" class="option center" data-mood="Ø§Ø³ØªØ±Ø³ÛŒ">ğŸ˜°<div class="small muted">Ø§Ø³ØªØ±Ø³</div></div>
            </div>
          </div>
        </section>

        <!-- Step 3: Time + Barrier -->
        <section class="step-card hidden" data-step="3" aria-hidden="true">
          <div class="center mb-2">
            <div class="text-lg font-semibold">Û³ â€” Ú†Ù‚Ø¯Ø± ÙˆÙ‚Øª Ø¯Ø§Ø±ÛŒ Ùˆ Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ù…Ø²Ø§Ø­Ù… Ø§Ø³ØªØŸ</div>
            <div class="muted mt-1">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆÙ‚Øª Ùˆ Ù…ÙˆØ§Ù†Ø¹ Ø·Ø±Ø§Ø­ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….</div>
          </div>

          <div class="mt-3">
            <label class="small mb-1 block">Ù…Ø¯Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³</label>
            <div class="grid grid-cols-3 gap-2">
              <div tabindex="0" role="button" class="option center" data-time="Û±Ûµ-Û³Û°">âš¡<div class="small muted">Û±Ûµâ€“Û³Û°</div></div>
              <div tabindex="0" role="button" class="option center selected" data-time="Û¶Û°">ğŸ•<div class="small muted">Û± Ø³Ø§Ø¹Øª</div></div>
              <div tabindex="0" role="button" class="option center" data-time="Û±Û²Û°+">ğŸ“…<div class="small muted">Û²+ Ø³Ø§Ø¹Øª</div></div>
            </div>
          </div>

          <div class="mt-4">
            <label class="small mb-1 block">Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø­ÙˆØ§Ø³Øª Ø±Ø§ Ù¾Ø±Øª Ú©Ù†Ø¯ØŸ</label>
            <div class="grid grid-cols-2 gap-2">
              <div tabindex="0" role="button" class="option center selected" data-barrier="Ú¯ÙˆØ´ÛŒ">ğŸ“±<div class="small muted">Ú¯ÙˆØ´ÛŒ</div></div>
              <div tabindex="0" role="button" class="option center" data-barrier="Ø®Ø³ØªÚ¯ÛŒ">ğŸ˜´<div class="small muted">Ø®Ø³ØªÚ¯ÛŒ</div></div>
              <div tabindex="0" role="button" class="option center" data-barrier="Ø³Ø± Ùˆ ØµØ¯Ø§">ğŸ”Š<div class="small muted">Ø³Ø± Ùˆ ØµØ¯Ø§</div></div>
              <div tabindex="0" role="button" class="option center" data-barrier="Ø¨ÛŒâ€ŒØ­ÙˆØµÙ„Ú¯ÛŒ">ğŸ˜‘<div class="small muted">Ø¨ÛŒâ€ŒØ­ÙˆØµÙ„Ú¯ÛŒ</div></div>
            </div>
          </div>
        </section>

        <!-- Step 4: Review & Generate -->
        <section class="step-card hidden" data-step="4" aria-hidden="true">
          <div class="center mb-2">
            <div class="text-lg font-semibold">Û´ â€” Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</div>
            <div class="muted mt-1">Ø®Ø±ÙˆØ¬ÛŒÙ ÙˆØ§Ø¶Ø­ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØªØª Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>

          <div class="mt-3">
            <div class="small mb-1">Ø®Ù„Ø§ØµÙ‡Ù” ÙˆØ¶Ø¹ÛŒØª</div>
            <div id="summaryBox" class="p-3 rounded-lg bg-gray-50 small muted"></div>
          </div>

          <div class="mt-3">
            <div class="small mb-1">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ù† (Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ØŒ Ù‚Ø¯Ù…â€ŒØ¨Ù‡â€ŒÙ‚Ø¯Ù…)</div>
            <div id="promptArea" class="prompt-box mt-2">Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆÛŒ Â«Ø¨Ø³Ø§Ø²Â» Ø¨Ø²Ù†.</div>
          </div>

          <div class="mt-3 small muted">Ù†Ú©ØªÙ‡: Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø± Ù‚Ø§Ù„Ø¨ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ If-Then Ø¢Ù…Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø¯Ø± Ù…ÙˆØ§Ø¬Ù‡Ù‡ Ø¨Ø§ Ù…Ø§Ù†Ø¹ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø¯Ø§Ù†ÛŒ Ú†ÛŒÚ©Ø§Ø± Ú©Ù†ÛŒ.</div>
        </section>
      </div>
    </div>

    <!-- Nav -->
    <div class="nav">
      <button id="backBtn" class="btn ghost" aria-label="Ù‚Ø¨Ù„ÛŒ">â† Ù‚Ø¨Ù„ÛŒ</button>
      <button id="nextBtn" class="btn primary" aria-label="Ø¨Ø¹Ø¯ÛŒ">Ø¨Ø¹Ø¯ÛŒ â†’</button>
    </div>

    <!-- Save indicator (floating) -->
    <div id="saveToast" class="fixed bottom-6 left-6 bg-black text-white px-3 py-2 rounded-full text-xs hidden">Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯</div>
  </div>

  <script>
  (function(){
    // ---------- Helpers ----------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
    const STORAGE = 'behavioral_mobile_v1';

    function toPersian(num){
      const map = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
      return String(num).replace(/\d/g, d => map[d]);
    }

    // ---------- State ----------
    const state = {
      step: 0, // warm-start is 0, then 1..4
      total: 4,
      data: {
        pledged: false,
        task: '',
        energy: 5,
        mood: 'Ø®Ø³ØªÙ‡',
        time: 'Û¶Û°',
        barrier: 'Ú¯ÙˆØ´ÛŒ',
        createdAt: new Date().toISOString()
      },
      autosaveTimer: null
    };

    // ---------- Elements ----------
    const appBody = $('#appBody');
    const stepNumEl = $('#stepNum');
    const progressBar = $('#progressBar');
    const wizardPanels = $$('[data-step]');
    const backBtn = $('#backBtn');
    const nextBtn = $('#nextBtn');
    const saveToast = $('#saveToast');

    // Warm
    const pledgeYes = $('#pledgeYes');
    const pledgeNo = $('#pledgeNo');

    // Step1
    const taskInput = $('#taskInput');
    const taskOptions = $$('.step-card[data-step="1"] .option');

    // Step2
    const energyRange = $('#energyRange');
    const energyVal = $('#energyVal');
    const moodButtons = $$('.step-card[data-step="2"] .option');

    // Step3
    const timeButtons = $$('.step-card[data-step="3"] .option[data-time]');
    const barrierButtons = $$('.step-card[data-step="3"] .option[data-barrier]');

    // Step4
    const summaryBox = $('#summaryBox');
    const promptArea = $('#promptArea');

    // ---------- Load / Save ----------
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE);
        if(raw){
          const parsed = JSON.parse(raw);
          Object.assign(state.data, parsed);
          console.log('state loaded', state.data);
        }
      }catch(e){}
    }

    function save(){
      try{
        localStorage.setItem(STORAGE, JSON.stringify(state.data));
        flashSave();
      }catch(e){}
    }

    function scheduleSave(){
      if(state.autosaveTimer) clearTimeout(state.autosaveTimer);
      state.autosaveTimer = setTimeout(save, 700);
    }

    function flashSave(){
      saveToast.classList.remove('hidden');
      saveToast.style.opacity = '1';
      setTimeout(()=>{ saveToast.style.opacity = '0'; saveToast.classList.add('hidden'); }, 1100);
    }

    // ---------- UI helpers ----------
    function showStep(n){
      state.step = n;
      // hide all panels
      wizardPanels.forEach(p => p.classList.add('hidden'));
      // show warm (0) or step n
      const panel = document.querySelector('.step-card[data-step="'+n+'"]');
      if(panel) panel.classList.remove('hidden');
      // update progress
      const pct = ((n+1) / (state.total + 1)) * 100; // warm included for smoother feeling
      progressBar.style.width = pct + '%';
      stepNumEl.textContent = toPersian(Math.max(1, n));
      // nav labels
      backBtn.disabled = (n === 0);
      backBtn.classList.toggle('opacity-50', n === 0);
      if(n < state.total) {
        nextBtn.textContent = 'Ø¨Ø¹Ø¯ÛŒ â†’';
      } else {
        nextBtn.textContent = 'Ø¨Ø³Ø§Ø²';
      }
      // refresh live summary
      renderLiveSummary();
    }

    function renderLiveSummary(){
      // create small summary for step 4
      const d = state.data;
      const t = d.task || 'â€”';
      const s = `Ú©Ø§Ø±: ${t} Â· Ø§Ù†Ø±Ú˜ÛŒ: ${toPersian(d.energy)}/Û±Û° Â· Ø­Ø§Ù„Øª: ${d.mood} Â· ÙˆÙ‚Øª: ${d.time} Â· Ù…Ø§Ù†Ø¹: ${d.barrier}`;
      summaryBox.textContent = s;
    }

    // ---------- Interaction bindings ----------
    // Warm start
    pledgeYes.addEventListener('click', ()=> {
      state.data.pledged = true;
      scheduleSave();
      showStep(1);
    });
    pledgeNo.addEventListener('click', ()=> {
      // gentle nudge: still allow proceed but mark as not pledged
      state.data.pledged = false;
      scheduleSave();
      showStep(1);
    });

    // Step1: task input & options
    taskInput.value = state.data.task || '';
    taskInput.addEventListener('input', e => {
      state.data.task = e.target.value.trim();
      scheduleSave();
      renderLiveSummary();
    });
    taskOptions.forEach(opt => {
      opt.addEventListener('click', ()=> {
        taskOptions.forEach(x=>x.classList.remove('selected'));
        opt.classList.add('selected');
        const v = opt.dataset.val;
        state.data.task = v;
        taskInput.value = v;
        scheduleSave();
        renderLiveSummary();
      });
      opt.addEventListener('keydown', (e)=> { if(e.key === 'Enter' || e.key === ' ') opt.click(); });
    });

    // Step2: energy + mood
    energyRange.value = state.data.energy;
    energyVal.textContent = toPersian(state.data.energy);
    energyRange.addEventListener('input', (e)=>{
      const v = Number(e.target.value);
      state.data.energy = clamp(v,1,10);
      energyVal.textContent = toPersian(state.data.energy);
      scheduleSave();
      renderLiveSummary();
    });

    moodButtons.forEach(m => {
      if(m.dataset.mood === state.data.mood) m.classList.add('selected');
      m.addEventListener('click', ()=> {
        moodButtons.forEach(x=>x.classList.remove('selected'));
        m.classList.add('selected');
        state.data.mood = m.dataset.mood;
        scheduleSave();
        renderLiveSummary();
      });
    });

    // Step3: time & barrier
    timeButtons.forEach(tbtn => {
      if(tbtn.dataset.time === state.data.time) tbtn.classList.add('selected');
      tbtn.addEventListener('click', ()=> {
        timeButtons.forEach(x=>x.classList.remove('selected'));
        tbtn.classList.add('selected');
        state.data.time = tbtn.dataset.time;
        scheduleSave();
        renderLiveSummary();
      });
    });

    barrierButtons.forEach(bbtn => {
      if(bbtn.dataset.barrier === state.data.barrier) bbtn.classList.add('selected');
      bbtn.addEventListener('click', ()=> {
        barrierButtons.forEach(x=>x.classList.remove('selected'));
        bbtn.classList.add('selected');
        state.data.barrier = bbtn.dataset.barrier;
        scheduleSave();
        renderLiveSummary();
      });
    });

    // Nav
    backBtn.addEventListener('click', ()=>{
      const next = Math.max(0, state.step - 1);
      showStep(next);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    nextBtn.addEventListener('click', ()=>{
      if(state.step < state.total){
        // move next
        const next = Math.min(state.total, state.step + 1);
        showStep(next);
        window.scrollTo({top:0,behavior:'smooth'});
      } else {
        // generate final plan
        generatePlan();
      }
    });

    // keyboard: Enter to go next when input focused
    taskInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') nextBtn.click(); });

    // ---------- Behavioral logic: generate plan ----------
    // Helper: mood hint
    function moodAdvice(m){
      const map = {
        'Ø¹Ø§Ù„ÛŒ':'Ø³Ø·Ø­ Ø§Ù†Ø±Ú˜ÛŒ Ø¨Ø§Ù„Ø§ â€” Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ú©Ø§Ø± Ú†Ø§Ù„Ø´ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ø§Ø¯.',
        'Ù…Ø¹Ù…ÙˆÙ„ÛŒ':'Ø§Ù†Ø±Ú˜ÛŒ Ù…ØªÙˆØ³Ø· â€” Ø¨Ù‡ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯ Ø§Ø³Øª.',
        'Ø®Ø³ØªÙ‡':'Ø§Ù†Ø±Ú˜ÛŒ Ù¾Ø§ÛŒÛŒÙ† â€” Ú©Ø§Ø±Ù‡Ø§ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø±ÙØªØ§Ø±ÛŒ Ø¨Ø§Ø´Ù†Ø¯.',
        'Ø§Ø³ØªØ±Ø³ÛŒ':'Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: 1-2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±ÛŒÙ† Ø¢Ø±Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹.'
      };
      return map[m] || '';
    }

    function planGenerator(data){
      // Returns object: {immediate, steps[], ifthen, emergency}
      const task = data.task || (['ÛŒÚ©Ù… Ø¯Ø±Ø³ Ø¨Ø®ÙˆÙ†Ù…','Ú©Ø§Ø±Ù… Ø±Ùˆ Ø§Ù†Ø¬Ø§Ø§Ù… Ø¨Ø¯Ù…','ÙˆØ±Ø²Ø´ Ú©Ù†Ù…'])[Math.floor(Math.random()*3)];
      const energy = Number(data.energy);
      const t = data.time;
      // decide time bucket
      let bucket = 'hour';
      if(String(t).includes('Û±Ûµ') || String(t).includes('15')) bucket = 'short';
      if(String(t).includes('Û²') || String(t).includes('+')) bucket = 'long';

      // Base strategies using BJ Fogg (Motivation x Ability x Prompt)
      // We produce immediate tiny prompt + plan steps
      if(energy <= 3){
        if(bucket === 'short'){
          return {
            immediate: `Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ†ÙØ³ â†’ 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø³ÛŒØ§Ø± Ø³Ø§Ø¯Ù‡ Ø±ÙˆÛŒ Â«${task}Â»`,
            steps: [`10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø§Ø¯Ø§Ù…Ù‡â€ŒØ¯Ø§Ø± Ø¨Ø§ ØªØ§ÛŒÙ…Ø±`],
            ifthen: data.barrier === 'Ú¯ÙˆØ´ÛŒ' ? 'If-Then: Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¯Ø± Ø§ØªØ§Ù‚ Ø¯ÛŒÚ¯Ø± Ø¨Ú¯Ø°Ø§Ø±.' : 'If-Then: Ø§Ú¯Ø± Ø®Ø³ØªÙ‡ Ø´Ø¯ÛŒØŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù†.',
            emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø§ Ù‡Ø¯Ù Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú©'
          };
        }
        if(bucket === 'hour'){
          return {
            immediate: `Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ â†’ 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø³Ø§Ø¯Ù‡ Ø±ÙˆÛŒ Â«${task}Â»`,
            steps: [`20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø§ ØªØ§ÛŒÙ…Ø± 20/5`],
            ifthen: data.barrier === 'Ú¯ÙˆØ´ÛŒ' ? 'If-Then: Ø²Ù…Ø§Ù† Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†.' : 'If-Then: Ø§Ú¯Ø± Ø­ÙˆØ§Ø³Øª Ù¾Ø±Øª Ø´Ø¯ØŒ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ú¯Ø±Ø¯.',
            emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ú©ÙˆÚ†Ú©'
          };
        }
        return {
          immediate: `Ø´Ø±ÙˆØ¹: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· â†’ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡ Ø±ÙˆÛŒ Â«${task}Â»`,
          steps: [`30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù‡ 2 Ø¨Ø®Ø´ 15/5 ØªÙ‚Ø³ÛŒÙ… Ú©Ù†`],
          ifthen: 'If-Then: Ø§Ú¯Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯ÛŒØŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ú©ÙˆØªØ§Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡.',
          emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ø­Ø¯Ø§Ù‚Ù„ÛŒ'
        };
      }

      if(energy <= 6){
        if(bucket === 'short'){
          return {
            immediate: `Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†: 30 Ø«Ø§Ù†ÛŒÙ‡ Ù‡Ø¯Ùâ€ŒÚ¯Ø°Ø§Ø±ÛŒ â†’ 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Â«${task}Â»`,
            steps: [`15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± + 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ±`],
            ifthen: data.barrier === 'Ú¯ÙˆØ´ÛŒ' ? 'If-Then: Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ú©Ù†.' : 'If-Then: Ù‡Ø¯ÙÙˆÙ† Ø¨Ø²Ù†.',
            emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù¾ÛŒÙˆØ³ØªÙ‡'
          };
        }
        if(bucket === 'hour'){
          return {
            immediate: `Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ¹ÛŒÛŒÙ† Ù‡Ø¯Ù â†’ 45 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø²`,
            steps: [`45 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ±`],
            ifthen: 'If-Then: Ø§Ú¯Ø± Ù…Ø²Ø§Ø­Ù… Ø´Ø¯ÛŒØŒ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ†ÙØ³ Ú©Ù† Ø³Ù¾Ø³ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡.',
            emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ ØªÙ…Ø±Ú©Ø²'
          };
        }
        return {
          immediate: `Ø´Ø±ÙˆØ¹: 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ â†’ 90 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø³Ø§Ø®ØªØ§Ø±ÛŒ`,
          steps: [`90 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ 3 Ø¨Ø®Ø´ 30 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ`],
          ifthen: 'If-Then: Ø§Ú¯Ø± ØªÙ…Ø±Ú©Ø² Ø±ÙØªØŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù†.',
          emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø´Ø®Øµ'
        };
      }

      // high energy
      if(bucket === 'short'){
        return {
          immediate: `Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†: 30 Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ â†’ 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù¾ÙØ±Ø§Ù†Ø±Ú˜ÛŒ Ø±ÙˆÛŒ Â«${task}Â»`,
          steps: [`20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø´Ø®Øµ`],
          ifthen: 'If-Then: Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ú©Ù†.',
          emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ù…ØªÙ…Ø±Ú©Ø²'
        };
      }
      if(bucket === 'hour'){
        return {
          immediate: `Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‡Ø¯Ùâ€ŒÚ¯Ø°Ø§Ø±ÛŒ â†’ 90 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± Ø¹Ù…ÛŒÙ‚ (50/10/30)`,
          steps: [`60 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø§Ø± + 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª + 20 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø±ÙˆØ±`],
          ifthen: 'If-Then: Ø§Ú¯Ø± Ù…Ø²Ø§Ø­Ù… Ø´Ø¯ÛŒØŒ Ø§Ø² Ù…Ø­ÛŒØ· ÙØ§ØµÙ„Ù‡ Ø¨Ú¯ÛŒØ±.',
          emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 40 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ ØªÙ…Ø±Ú©Ø²'
        };
      }
      return {
        immediate: `Ø´Ø±ÙˆØ¹: 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·Ø±Ø­â€ŒØ±ÛŒØ²ÛŒ â†’ 2+ Ø³Ø§Ø¹Øª Ø¨Ù„ÙˆÚ© Ø¹Ù…ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Â«${task}Â»`,
        steps: [`2 Ø³Ø§Ø¹Øª ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ 2 Ø¬Ù„Ø³Ù‡ 50 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ`],
        ifthen: 'If-Then: Ø¯Ø± ØµÙˆØ±Øª ÙˆÙ‚ÙÙ‡ Ø·ÙˆÙ„Ø§Ù†ÛŒØŒ 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¯Ù… Ø¨Ø²Ù† Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡.',
        emergency: 'Ù†Ø³Ø®Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: 60 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø´Ø®Øµ'
      };
    }

    function buildPromptText(stateData){
      const plan = planGenerator(stateData);
      const d = stateData;
      const lines = [];
      lines.push(`# âš¡ Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” ÙÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹`);
      lines.push(`- Ú©Ø§Ø±: ${d.task || 'ÛŒÚ© Ú©Ø§Ø± Ú©ÙˆÚ†Ú©'}`);
      lines.push(`- Ø§Ù†Ø±Ú˜ÛŒ: ${d.energy}/10 â€” ${moodAdvice(d.mood)}`);
      lines.push(`- Ø²Ù…Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯: ${d.time}`);
      lines.push(`- Ù…Ø§Ù†Ø¹: ${d.barrier}`);
      lines.push('');
      lines.push(`## Ø´Ø±ÙˆØ¹ ÙÙˆØ±ÛŒ:`);
      lines.push(plan.immediate);
      lines.push('');
      lines.push(`## Ø¨Ø±Ù†Ø§Ù…Ù‡Ù” Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ:`);
      plan.steps.forEach((s,i)=> lines.push((i+1)+'. '+s));
      lines.push('');
      lines.push(`## If-Then:`);
      lines.push(plan.ifthen);
      lines.push('');
      lines.push(`## Ù†Ø³Ø®Ù‡Ù” Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ:`);
      lines.push(plan.emergency);
      lines.push('');
      lines.push(`(Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ú©ÙˆØªØ§Ù‡ØŒ ÙÙ‡Ø±Ø³Øªâ€ŒØ´Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø¯Ù‡ â€” Ù‡Ø± Ù‚Ø¯Ù… Ø²ÛŒØ± 15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§Ø´Ø¯.)`);
      return lines.join('\\n');
    }

    function generatePlan(){
      // ensure latest UI data
      state.data.task = taskInput.value.trim() || state.data.task;
      // render prompt
      const prompt = buildPromptText(state.data);
      promptArea.textContent = prompt;
      // show step 4 panel if not shown
      showStep(4);
      save();
    }

    // ---------- Init ----------
    function init(){
      load();
      // apply state to UI
      taskInput.value = state.data.task || '';
      energyRange.value = state.data.energy || 5;
      energyVal.textContent = toPersian(state.data.energy || 5);
      // mark selected options based on loaded data
      // step1 options
      $$('.step-card[data-step="1"] .option').forEach(o=>{
        if(o.dataset.val === state.data.task) o.classList.add('selected');
      });
      // mood
      moodButtons.forEach(m => { if(m.dataset.mood === state.data.mood) m.classList.add('selected'); });
      // time
      timeButtons.forEach(t => { if(t.dataset.time === state.data.time) t.classList.add('selected'); });
      // barrier
      barrierButtons.forEach(b => { if(b.dataset.barrier === state.data.barrier) b.classList.add('selected'); });

      // initial view (warm)
      showStep(0);
    }

    init();

    // expose generatePlan for debugging
    window._generatePlan = generatePlan;

  })();
  </script>
</body>
</html>
